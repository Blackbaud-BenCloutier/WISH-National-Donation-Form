<script>
jQuery(document).ready(function ($) {
  var isPaypal = false,
    paypalRedirectUrl = '', 
    xmlHttp = new XMLHttpRequest(),
    zip_array = (function(){$.getJSON('../assets/js/zip-codes.json', function (data) {return data});})(),
    showError = function(pageError, fieldError) {
      alert(pageError + " " + fieldError);
      $("a.button-submit").css("cursor", "pointer").removeClass("disabled").removeAttr("disabled");
    },
    lastStep = function() {
      $.removeCookie("cart");
      $.jStorage.flush();
      localStorage.clear();
      savedSession = {}
      $("#mainform input").each(function () {
        $(this).val("");
      });
      window.onbeforeunload = function () {};
      if(isPaypal) {
        window.location = paypalRedirectUrl;
      }
      else {
        window.location = "https://secure2.convio.net/wish/site/SPageServer?pagename=donate_thankyou";
      }
    },
    finishGift = function() {
      var survey_ids = [];
      if ($('#optinNational').is(':checked')) {
        survey_ids.push("1604");
      }
      if ($('#optinInternational').hasClass('checked')) {
        survey_ids.push("1625");
      }
      if ($('#optinChapter').is(':checked')) {
        $(chaptersjson['allChapters']['chapter']).each(function (index, arr) {
          if (arr['office_id'] == $('#chapter_id').val()) {
            survey_ids.push(arr['surveyID']);
          }
        });
      }
      if (survey_ids.length > 0) {
        for (var i = 0; i < survey_ids.length; i++) {
          if ((navigator.userAgent.match(/MSIE 9/i))) {
            xmlHttp.abort();
          }
          if (i + 1 == survey_ids.length) {
            donation_data = "method=submitSurvey&cons_email=" + encodeURIComponent($("#eAdd").val()) + "&cons_email_opt_in=true&survey_id=" + survey_ids[i];
            luminateExtend.api.request({
              api: 'survey',
              data: data,
              callback: lastStep,
              requiresAuth: true,
              requestType: 'POST',
              useHTTPS: true
            });
          } else {
            donation_data = "method=submitSurvey&cons_email=" + encodeURIComponent($("#eAdd").val()) + "&cons_email_opt_in=true&survey_id=" + survey_ids[i];
            luminateExtend.api.request({
              api: 'survey',
              data: donation_data,
              requiresAuth: true,
              requestType: 'POST',
              useHTTPS: true
            });
          }
        }
      } else {
        lastStep();
      }
    };
  luminateExtend.init({
    apiKey: 'mu3fefod',
    path: {
      nonsecure: 'http://site.wish.org/site/',
      secure: 'https://secure2.convio.net/wish/site/'
    }
  });
  $('#ccPostal').blur(function(e){
    var id_from_billing_zip;  
    $(zip_array['chapter']).each(function (index, arr) {
      if (arr['zip_code'] == $('#ccPostal').val()) {
        id_from_billing_zip = arr['chapter_id'];
        $('#chapter_id').val(id_from_billing_zip);
      } 
    });  
  });
  $("a.action-btn, a.btn-modal").click(function (e) {
    e.preventDefault();
  });
  // Standard donation submit button
  $("a.button-submit:eq(0)").click(function (e) {
    e.preventDefault();
    $(this).css("cursor", "not-allowed").addClass("disabled").attr("disabled", true).click(function (e) {
      e.preventDefault();
    });
    getDonationInfo();
    // Set level_id
    luminateExtend.api.request({
      api: 'donation',
      data: 'method=getDonationFormInfo&form_id=' +
        /form_id=(\d{4,5})/.exec(data)[1],
      requestType: 'POST',
      callback: function (dfdata) {
        if(dfdata.errorResponse) {
          donation_data += '&level_id=2031';
        } else {
          donation_data += '&level_id=' + dfdata.getDonationFormInfoResponse.donationLevels.donationLevel[3].level_id;
        }
        luminateExtend.api.request({
          api: 'donation',
          form: '#mainform',
          data: donation_data,
          requestType: 'POST',
          callback: function (data) {
            if (data['donationResponse']['donation']) {
              finishGift();
            }
            if (data['donationResponse']['errors']) {
              var fieldError = "";
              if (data['donationResponse']['errors']['fieldError']) {
                if ($.isArray(data['donationResponse']['errors']['fieldError'])) {
                  $(data['donationResponse']['errors']['fieldError']).each(function (index, arr) {
                    fieldError = fieldError + arr + " ";
                  });
                } else {
                  fieldError = data['donationResponse']['errors']['fieldError'];
                }
              }
              showError(data['donationResponse']['errors']['pageError'], fieldError);
            }
          }
        });
      }
    });
  });
  // PayPal button
  $("a.button-submit:eq(1)").click(function (e) {
    e.preventDefault();
    $(this).css("cursor", "not-allowed").addClass("disabled").attr("disabled", true).click(function (e) {
      e.preventDefault();
    });
    var paypalData = donation_data.replace('donate','startDonation') + '&extproc=paypal&finish_success_redirect=[[T1:https://secure2.convio.net/wish/site/SPageServer?pagename=donate_thankyou]]&finish_error_redirect=[[T1:https://secure2.convio.net/wish/site/SPageServer?pagename=donate_paypal_error]]';
    getDonationInfo();
    // Set level_id
    luminateExtend.api.request({
      api: 'donation',
      data: 'method=getDonationFormInfo&form_id=' +
        /form_id=(\d{4,5})/.exec(donation_data)[1],
      requestType: 'POST',
      callback: function (data) {
        if(data.errorResponse) {
          donation_data += '&level_id=2031';
        } else {
          donation_data += '&level_id=' + data.getDonationFormInfoResponse.donationLevels.donationLevel[3].level_id;
        }
        luminateExtend.api.request({
          api: 'donation',
          form: '#mainform',
          data: paypalData,
          requestType: 'POST',
          callback: function (data) {
            if (data['donationResponse']['redirect']) {
              isPaypal = true;
              paypalRedirectUrl = data['donationResponse']['redirect']['url'];
              finishGift();
            }
            if (data['donationResponse']['errors']) {
              var fieldError = "";
              if (data['donationResponse']['errors']['fieldError']) {
                if ($.isArray(data['donationResponse']['errors']['fieldError'])) {
                  $(data['donationResponse']['errors']['fieldError']).each(function (index, arr) {
                    fieldError = fieldError + arr + " ";
                  });
                } else {
                  fieldError = data['donationResponse']['errors']['fieldError'];
                }
              }
              showError(data['donationResponse']['errors']['pageError'], fieldError);
            }
          }
        });
      }
    });
  });
});
</script>