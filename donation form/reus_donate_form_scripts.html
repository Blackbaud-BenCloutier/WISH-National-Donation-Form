<!-- All except productURL1 and productURL1Name were removed. - BDC 12/2/2013 -->
[[U0:productURL1=""]]
[[U0:productURL1Name=""]]

<style>.chapter-list-btn, .country-list-btn {color:gray !important;}#card_preview,#card_preview .blurb{display:none;}.product-thumb img{margin:0 !important;}</style>

<script src="../assets/js/jquery.zoom-min.js"></script>
<script src="../assets/js/jquery.jswipe.js" type="text/javascript"></script>
<script src="../assets/js/jquery.infinite-carousel.js" type="text/javascript"></script>

<script>

// Global var to track payment type - BDC 1/9/2014

window.isPaypal = false;
window.paypalRedirectUrl = '';

// Editable metadata fields - BDC 12/11/2013

[[S51:reus_donate_form_metadata]]

// Putting all the ZIP Codes into a variable for fast access - BDC 12/10/2013

var zip_array; $.getJSON('../assets/js/zip-codes.json', function (data) {zip_array = data});

// AJAX call to grab XML that associates centers to form IDs -- MRD 12/6/2013

center_forms = (function () {
  var xml = null;
  $.ajax({
    'async': false,
    'global': false,
    'url': 'https://secure2.convio.net/wish/assets/xml/center_info.xml',
    'dataType': "xml",
    'success': function (data) {
      xml = data;
    }
  });

  console.log(xml);

  return xml;
})();


$.fn.infiniteCarousel = function () { // this is the card selection carousel

  function repeat(str, num) {
    return new Array(num + 1).join(str);
  }

  return this.each(function () {
    var $wrapper = $('> div', this).css('overflow', 'hidden'),
      $slider = $wrapper.find('> ul'),
      $items = $slider.find('> li'),
      $single = $items.filter(':first'),

      singleWidth = 280,
      visible = Math.ceil($wrapper.innerWidth() / singleWidth);

    // 1. Pad so that 'visible' number will always be seen, otherwise create empty items
    if (visible === 0) {
      visible = 1;
    }

    if (($items.length < 3) != 0) {
      $slider.append(repeat('<li class="empty" />', visible - ($items.length % visible)));
      $items = $slider.find('> li');
    }

    // 2. Top and tail the list with 'visible' number of items, top has the last section, and tail has the first
    $items.filter(':first').before($items.slice($items.length - 1).clone().addClass('cloned'));
    $items.filter(':last').after($items.slice(0,1).clone().addClass('cloned'));
    $items = $slider.find('> li'); // reselect

    // 3. Set the left position to the first 'real' item
    $wrapper.scrollLeft(singleWidth);

    // 4. paging function
    function gotoPage(dir) {

      var left = singleWidth * dir; 

      $wrapper.filter(':not(:animated)').animate({
        scrollLeft: '+=' + left
      }, 500, function () {
        if (dir === 1) {
          $items.filter(':last').after($items.slice(2,3).clone());
          $items.filter(':first').remove();
        } else if (dir === -1) {
          $items.filter(':first').before($items.slice(3,4).clone());
          $items.filter(':last').remove();
        }
        $items = $slider.find('> li');
        $wrapper.scrollLeft(singleWidth);
      });

      return false;
    }

    $wrapper.after('<a class="arrow back"></a><a class="arrow forward"></a>');

    // 5. Bind to the forward and back buttons
    $('a.back', this).click(function () {
      return gotoPage(1);
    });

    $('a.forward', this).click(function () {
      return gotoPage(-1);
    });

    // create a public interface to move to a specific page
    $(this).bind('goto', function (event, page) {
      gotoPage(page);
    });
  });
};

$(document).ready(function () {

  $('#saveAdd').hide();

  $.jStorage.deleteKey("hideGiftType");

  var donationID = $('.js_donationConfigurator').attr('data-donation-id'), //random number
  cardProperties = [], 
  giftTypeButtons = $("#giftTypes").html(), // single and monthly buttons
  initProducts = $("ul#products").html(); // greyed out preview cards

  $("#saveAdd, .add-button").live('click', function () { // add donation buttons
    donationID = $('.js_donationConfigurator').attr('data-donation-id'); // dup
    // grey out donation button that's not clicked
    if ($("a#monthlyGift").hasClass("selected")) {
      $("a#monthlyGift").removeClass('disabled').addClass('selected').removeAttr("disabled").css("cursor", "pointer");
      $("a#monthlyGift").trigger("click");
      $("a#singleGift").addClass('disabled').attr('disabled', true).unbind('click').removeClass("selected").css("cursor", "not-allowed");
      $("a#singleGift").click(function (e) {
        e.preventDefault();
      });

    }
    // grey out donation button that's not clicked
    if ($("a#singleGift").hasClass("selected")) {

      $("a#monthlyGift").addClass('disabled').attr('disabled', true).unbind('click').css("cursor", "not-allowed");
      $("a#monthlyGift").click(function (e) {
        e.preventDefault();
      });

    }
  });

  $('.infiniteCarousel').infiniteCarousel(); // init infiniteCarousel
  $('select.event-select').customSelectMenu(); // select occasion
  $('select.type-select').customSelectMenu(); // select card type
  $('.option-one li:first').remove(); // remove list item
  $('.option-two li:first').remove(); // remove list item
  if ($("select.event-select option").val() == '') { // if no occasion chosen, disable everything
    $('.select-area-2').addClass('disabled');
    $('.select-area-3').addClass("disabled");
    $('#carousel-gallery').addClass("disabled");
    $('.option-two ul').css({
      opacity: 0
    });
  }

  var showStep1 = function () {
    $('.top-actions .back-btn').hide();
    $('.top-actions .cancel-btn').show();
    $('#js-prod-personalizer h1').text('Select a certificate, card, or e-card');
    $('#step1').show();
    $('#step2').hide();
    $('#step3').hide();
  }

  var showStep2 = function () {
    $('.top-actions .back-btn').show();
    $('.top-actions .cancel-btn').hide();
    $('#js-prod-personalizer h1').text('Select a certificate, card, or e-card');
    $('#step1').hide();
    $('#step2').show();
    $('#step3').hide();
  }

  function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
      vars[key] = value;
    });
    return vars;
  }

  var urlVariableArray = getUrlVars();

  $(window).load(function () {
    for (var index in urlVariableArray) {
      if (index == "card_type") {
        launchCard(urlVariableArray[index]);
      }
    }
  });

  var productsjson = (function () {
    var json = null;
    $.ajax({
      'async': false,
      'global': false,
      'url': 'https://secure2.convio.net/wish/assets/js/products.json?server_refresh=[[S55:0,9999,5]]',
      'dataType': "json",
      'success': function (data) {
        json = data;
      }
    });
    return json;
  })();

  var checkFields = function () {

    var emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/,
    flag = true;

    function validateFail(currentElement) {
      currentElement.addClass('input-error');
      currentElement.next("p").show();
      currentElement.prev("label").addClass("label-error");
      $(".bldr-wrap #card-form .mnamefld").prev("fieldset").css({
        "position": "relative;"
      });
      $(".bldr-wrap #card-form .mnamefld").css({
        "left": "300px",
        "margin-left": "12px",
        "position": "absolute",
        "top": "12px"
      });
      if ($("#State_X").hasClass("input-error")) {
        $("#uniform-State_X span").addClass("input-error");
        $("#uniform-State_X").next("p").show();
        $("#uniform-State_X").prev("label").addClass("label-error");
      }
      flag = false;
    }

    function validatePass(currentElement) {
      currentElement.removeClass('input-error');
      currentElement.next("p").hide();
      currentElement.prev("label").removeClass("label-error");
      /*$(".bldr-wrap #card-form .mnamefld").css({

      });*/
      if ($("#State_X").hasClass("input-error")) {
        $("#uniform-State_X span").removeClass("input-error");
        $("#uniform-State_X").next("p").hide();
        $("#uniform-State_X").prev("label").removeClass("label-error");
      }
    }

    $('#step3 .jsreq:visible').each(function () {
      if ($(this).hasClass('js_email')){
        if(emailRegex.test($(this).val())) {
          validatePass($(this));
        } else {
          validateFail($(this));
        }
      } else if ($(this).val() == '') {
        validateFail($(this));
      } else {
        validatePass($(this));
      }
    });
    return flag;
  }

  // Get available occasions and add to first drop down list
  var occasionTypes = [];

  $(productsjson['product']).each(function (index, arr) {
    if ($.inArray(arr['occasion_type'], occasionTypes) == -1) {
      occasionTypes.push(arr['occasion_type']);
    }
  });
  for (var i in occasionTypes) {
    $('.event-select').append('<option value="' + occasionTypes[i] + '">' + occasionTypes[i] + '</option>')
    $('#selectOccasion ul').append('<li data-option-value="' + occasionTypes[i] + '">' + occasionTypes[i] + '</li>')
  }

  function launchCard(id) {
    console.log("Card ID: " + id);

    $.fancybox({
      href: '#js-prod-personalizer',
      autoSize: false,
      width: '1018px',
      height: '585px',
      padding: 0,
      scrolling: 'no',
      modal: true,
      closeBtn: false,
      margin: [5, 5, 5, 5],
      afterShow: function () {
        mawf.$personalizer.find('select').trigger('change'); // Uniform needs help with session restore update of hidden selects
        $.fancybox.update(); // Ensure fancybox resizes to be scrollable with lower resolutions  
      },
      afterClose: function () {
        mawf.shutDownProductModal();
      }
    });

    selectCard(id);
  }

  // When an occasion is selected, load available card types for it in the second drop down list

  $(".option-one").on('click', 'li', function (e) {
    e.preventDefault();
    var thisEcardProduct = [];
    var thisCertificateProduct = [];
    var thisCardProduct = [];
    $('#finishCertificate, #finishCard, #finisheCard').unbind("click");

    if (!$("#carousel-gallery").hasClass("disabled")) {
      $("ul#products").remove();
      $("a.arrow").remove();
      $("h4#cardCount").text("");
    }

    var thisOccasion = $(this).text();
    var availableTypes = [];

    $(productsjson['product']).each(function (index, arr) {
      if (arr['occasion_type'] == thisOccasion && $.inArray(arr['card_type'], availableTypes) == -1) {
        availableTypes.push(arr['card_type']);
      }
    });
    var optionHTML = "";
    var listHTML = "";
    var certificateMsg = "Create a printable certificate.";
    var cardMsg = "We\'ll mail a card on your behalf.";
    var ecardMsg = "Send an e-card.";

    for (i in availableTypes) {
      optionHTML += '<option value="' + availableTypes[i] + '">' + availableTypes[i] + '</option>';
      listHTML += '<li data-option-value="' + availableTypes[i] + '">' + availableTypes[i] + '<br /><span>';
      if (availableTypes[i] == "Certificate") {
        listHTML += certificateMsg;
      }
      if (availableTypes[i] == "Card") {
        listHTML += cardMsg;
      }
      if (availableTypes[i] == "E-Card") {
        listHTML += ecardMsg;
      }
      listHTML += '</span></li>';
    }

    $('.type-select').html(optionHTML);
    $('#selectCardType ul').html(listHTML);

    $('#selectCardType label').text('Select Card Type');
    $('div.select-area-2').removeClass("disabled");
    $('.option-two ul').css({
      opacity: 1
    });
  });

  /////////////////////////////////////////////////////////////////////////////////////////////

  // When a card type is selected, load the ecards into the carousel

  function optionTwo(thisCardType) {

    var occasionType = $('#selectOccasion input[type=hidden]').val();
    
    var products = [];
    var cardCount = 0;

    $(productsjson['product']).each(function (index, arr) {
      if (arr['card_type'] == thisCardType && arr['occasion_type'] == occasionType) {
        if (arr['is_new'].toLowerCase() == "true") {
          products.push('<li><div class="hover-bar"><a class="magnify" href="#" data-cardID="' + arr['card_id'] + '"></a><a class="select-card" href="#" data-cardID="' + arr['card_id'] + '"></a></div><img src="' + arr['card_image1'] + '" class="new-item"></li>');
        } else {
          products.push('<li><div class="hover-bar"><a class="magnify" href="#" data-cardID="' + arr['card_id'] + '"></a><a class="select-card" href="#" data-cardID="' + arr['card_id'] + '"></a></div><img src="' + arr['card_image1'] + '"></li>');
        }
        cardCount++
      }
    });

    $("ul#products").remove();
    $("a.arrow").remove();
    if (cardCount > 3) {
      $('#carousel-gallery .wrapper').append('<ul id="products">' + products + products + '</ul>');
    } else {
      $('#carousel-gallery .wrapper').append('<ul id="products">' + products + '</ul>');
    }
    $('.infiniteCarousel').infiniteCarousel();

    if (cardCount < 3) {
      $("a.arrow").unbind("click").css({
        'opacity': '.2',
        'cursor': 'none'
      });
      $("a.arrow").click(function (e) {
        e.preventDefault();
      });
    }

    addNewTag();

    if (cardCount == 1) {
      $('#cardCount').text(cardCount + '  Card');
    } else {
      $('#cardCount').text(cardCount + '  Cards');

    }

    $('div.select-area-3').removeClass("disabled");
    $('div#carousel-gallery').removeClass("disabled");

  }

  $(".option-two").on('click', 'li', function (e) {
    e.preventDefault();

    var cardType = $('#selectCardType input[type=hidden]').val();
    optionTwo(cardType);

  });

  $(".option-two li>span").live("click", function () {
    console.log("click: " + $(this).parent().attr("data-option-value"));
    var cardType = $(this).parent().attr("data-option-value");
    optionTwo(cardType);
  });

  var addNewTag = function () {
    $('li img.new-item').after('<span><img src="https://secure2.convio.net/wish/assets/images/new-tag.png" /></span>');
    $('ul#products > li').hover(function () {
      $(this).after('');
    });
  }
  /////////////////////////////////////////////////////////////////////////////////////////////

  $('.wrapper').on('click', 'a.magnify', function (e) {
    if (!$(this).parents().hasClass('disabled')) {
      e.preventDefault();

      var card_id = $(this).attr('data-cardid');

      if (card_id.substring(0, 2) == 'EC') {
        selectEcard(card_id);
      } else {
        selectCard(card_id);
      }

    }
  });

  $('.wrapper').on('click', 'a.select-card', function (e) {
    if (!$(this).parents().hasClass('disabled')) {
      e.preventDefault();

      var card_id = $(this).attr('data-cardid');

      customizeCard(card_id);

    }
  });

  var ecard_id = "";
  var card_name = "";
  var card_type = "";
  var card_form = "";
  var occasion_type = "";
  var card_image1 = "";
  var card_image2 = "";
  var card_image3 = "";
  var card_image4 = "";
  var card_image5 = "";
  var card_thumbnail = "";
  var product_url = "";
  var skew = "";  

  // When a card is selected, load the description page

  function selectEcard(cardID) {
    $(productsjson['product']).each(function (index, arr) {
      if (arr['card_id'] == cardID) {
        ecard_id = arr['ecard_id'] || false;
        product_url = arr['product_url'] || false;
        return false;
      }
    });
    window.open(product_url, "ecard",
'height=670,width=737,modal=yes,alwaysRaised=yes,toolbar=no,menubar=0,status=0,copyhistory=0,scrollbars=yes,resizable=1');
  }

  function selectCard(cardID) {

    $(productsjson['product']).each(function (index, arr) {
      if (arr['card_id'] == cardID) {
        ecard_id = arr['ecard_id'] || false;
        card_name = arr['card_name'];
        card_type = arr['card_type'];
        occasion_type = arr['occasion_type'];
        card_image1 = arr['card_image1'];
        card_image2 = arr['card_image2'] || false;
        card_image3 = arr['card_image3'] || false;
        card_image4 = arr['card_image4'] || false;
        card_image5 = arr['card_image5'] || false;
        card_thumbnail = arr['card_thumbnail'] || "https://secure2.convio.net/wish/Card images/General/Certficates/blank.png";
        product_url = arr['product_url'] || false;
        return false;
      }
    });

    launchZoom(card_image2);


    function launchZoom(cardURL) {

      $('.productImageContainer').html('<span class="zoom" id="productImageContainer"><img id="zoom_preview" style="display: none;" src="' + cardURL + '" alt="" /></span>')

      $('#zoom_preview').load(function(){
          var productHeight = $(this).height();
          var productWidth = $(this).width();
          if (productHeight == productWidth) {
            $(this).addClass('square');
          } else if (productHeight > productWidth) {
            $(this).addClass('portrait');
          } else if (productHeight < productWidth) {
            $(this).addClass('landscape');
          }
          $(this).attr('style', '');   
        });

      $('#productImageContainer').zoom();
    }

    $('.cardDescription').load('https://secure2.convio.net/wish/site/SPageNavigator/reus_card_' + cardID + '.html #container');
    if (card_type = "card") {
      var cardThumbs = "";

      if (card_image3 != "") {
        cardThumbs = '<img src="' + card_image2 + '" class="card-thumb" />' + '<img src="' + card_image3 + '" class="card-thumb" />';
      }
      if (card_image4 != "") {
        cardThumbs = cardThumbs + '<img src="' + card_image4 + '" class="card-thumb" />';
      }
      if (card_image5 != "") {
        cardThumbs = cardThumbs + '<img src="' + card_image5 + '" class="card-thumb" />';
      }
      $(".card-thumbs").html(cardThumbs);
    }

    $("img.card-thumb").click(function (e) {
      e.preventDefault();
      var whichThumb = $(this).attr("src");
      launchZoom(whichThumb);
    });

    showStep2();

    $('.lightbox-rightside').on('click', 'a.cont-btn', function (e) {
      if (!$(this).parents().hasClass('disabled')) {
        e.preventDefault();
        customizeCard(cardID);
      }
    });
    return;
  }

  function customizeCard(cardID) {

    $(productsjson['product']).each(function (index, arr) {
      if (arr['card_id'] == cardID) {
        ecard_id = arr['ecard_id'] || false;
        card_name = arr['card_name'];
        card_type = arr['card_type'];
        card_form = arr['card_form'];
        occasion_type = arr['occasion_type'];
        card_image1 = arr['card_image1'];
        card_image2 = arr['card_image2'] || false;
        card_image3 = arr['card_image3'] || false;
        card_image4 = arr['card_image4'] || false;
        card_image5 = arr['card_image5'] || false;
        card_thumbnail = arr['card_thumbnail'] || "https://secure2.convio.net/wish/Card images/General/Certficates/blank.png";
        product_url = arr['product_url'] || false;
        skew = cardID;        

        // Setting Skew information to hidden input field for Satellite Data - MRD 12/12/13
        $("input[name='s_sat_skew']").val(skew);

        return false;
      }
    });

    showStep3(ecard_id, card_name, card_type, card_form, occasion_type, card_image1, card_image2, card_image3, card_thumbnail, product_url, skew);

    return;

  }

  //Cancel button clears selections
  $('.cancel-btn').click(function () {
    $.fancybox.close();
    resetProducts();
    // Setting Skew information to hidden input field for Satellite Data - MRD 12/13/13
    $("input[name='s_sat_skew']").val('');
  });

  //Reset Products
  function resetProducts() {
    $('#step3 .jsreq').each(function () {
      $(this).removeClass('input-error');
      $(this).next("p").hide();
      $(this).prev("label").removeClass("label-error");
    });

    $("#uniform-State_X span").removeClass("input-error");
    $("#uniform-State_X").next("p").hide();
    $("#uniform-State_X").prev("label").removeClass("label-error");
    $(".bldr-wrap #card-form .mnamefld").css({
      "left": "0px",
      "margin-left": "12px",
      "position": "relative",
      "top": "0px"
    });

    $(".option-one li.selected").removeClass("selected");
    $(".option-two li.selected").removeClass("selected");
    $(".option-one label").removeClass("selection-made").text("Select Occasion");
    $(".option-two label").removeClass("selection-made").text("Select Card Type");
    $(".option-one input").attr("value", "Select Occasion");
    $(".option-two input").attr("value", "Select Card Type");
    $('#cardCount').text("");
    $('.select-area-2').addClass('disabled');
    $('.select-area-3').addClass("disabled");
    $('#carousel-gallery').addClass("disabled");
    $('.option-two ul').css({
      opacity: 0
    });
    $('#carousel-gallery .wrapper').html('<ul id="products">' + initProducts + "</ul>");
    products = "";
    $("#step3 input").val("");
    $("#step3 textarea").val("");
    $("#State_X option:first").attr("selected", "selected");
    $('#step1').show();
    $('#step2').hide();
    $('#step3').hide();

    toFirstName = "";
    toMI = "";
    toLastName = "";
    toInHonorOf = "";
    toEmail = "";
    toFullName = "";
    fromName = "";
    toAddress1 = "";
    toAddress2 = "";
    toCity = "";
    toState = "";
    toZip = "";
    toCountry = "";
    message = "";
    ecardID = "";
    cardName = "";
    cardType = "";
    occasionType = "";
    cardImage1 = "";
    cardImage2 = "";
    cardImage3 = "";
    cardThumbnail = "";
    productURL = "";
    skew = "";
  }

  // If the "Back to Selection" button is clicked, go to step 1
  $('.top-actions .back-btn').click(function (e) {
    e.preventDefault();
    showStep1();
  });

  var showStep3 = function (ecardID, cardName, cardType, cardForm, occasionType, cardImage1, cardImage2, cardImage3, cardThumbnail, productURL, thisSkew) {
    $('#step1, #step2, .top-actions .back-btn').hide();
    $('#step3, .top-actions .cancel-btn').show();
    $('#step3 #productTitle').text(cardName);
    $('.cardThumbnail').attr('src', cardThumbnail);

    var toFirstName = "";
    var toMI = "";
    var toLastName = "";
    var toInHonorOf = "";
    var toEmail = "";
    var toFullName = "";
    var fromName = "";
    var toAddress1 = "";
    var toAddress2 = "";
    var toCity = "";
    var toState = "";
    var toZip = "";
    var toCountry = "";
    var message = "";


  if (card_form === "cert01" || card_form === "cert03") {
    // Add occasion type to hidden input field for Satellite Data
    $("input[name='s_sat_ecert_occasion_type']").val(occasionType);

    $('#js-prod-personalizer h1').text('Customize Certificate');

    $('#card-form fieldset, .bottomButtons a').hide();

    if (card_form === "cert01"){
      $('fieldset.cert01, #finishCertificate').show();
      $('#honor_info').html('Would you like a different name printed on the certificate?');
    } else if(card_form === "cert03") {
      $('fieldset.cert03, #finishCertificate').show();
      $('#memorial_info').html('Would you like a different name printed on the certificate?');
    }

    $('#from_info').html('Your name or family name will appear on the certificate exactly as you type it here. Limit 40 characters including spaces.');

    $('#finishCertificate').click(function (e) {
      e.preventDefault();
      if (checkFields()) {
        toFirstName = $("input[name='MemorialFirst_X_v2']").val();
        toMI = $("input[name='MemorialMI_X']").val() || false;
        toLastName = $("input[name='MemorialLast_X']").val();
        toInHonorOf = $("input[name='MemorialName_X']").val() || false;
        toFullName = "";
        fromName = $("input[name='LastName_X']").val();

        // If the "In honor of" field is blank, create full name from First, Middle, Last
        if (!toInHonorOf) {
          if (toMI) {
            toFullName = toFirstName + " " + toMI + " " + toLastName;
          } else {
            toFullName = toFirstName + " " + toLastName
          }
        } else {
          toFullName = toInHonorOf
        }

        // Preview card
        $('.product-thumb').append('<img src="' + decodeURIComponent(cardImage1) + '" width="140">');
        $('#card_preview').show();
        $('#card_create').hide();
        $('#card_in_honor_of').show().append('<p>' + decodeURIComponent(toFullName) + '</p>');
        $('#card_from').show().append('<p>' + decodeURIComponent(fromName) + '</p>');

        // Add the card info to the card list to process later
        cardProperties = [donationID, 'cert01', 'certificate', toFullName, fromName, productURL, cardName, occasionType, thisSkew];

        $.fancybox.close();
        resetProducts();
        return;
      }

      return;
    }); //click
  } else if (card_form === "cert02") {
    // Add occasion type to hidden input field for Satellite Data
    $("input[name='s_sat_ecert_occasion_type']").val(occasionType);

    $('#js-prod-personalizer h1').text('Customize Certificate');

    $('#card-form fieldset, .bottomButtons a').hide(); 

    $('fieldset.cert02, #finishCertificate').show(); 

    $('#finishCertificate').click(function (e) {
      e.preventDefault();

      if (checkFields()) {
        toFullName = $("input[name='MemorialFirst_X_v2']").val();

        // Preview card
        $('.product-thumb').append('<img src="' + decodeURIComponent(cardImage1) + '" width="140">');
        $('#card_preview').show();
        $('#card_create').hide();
        $('#card_wedding_couple_name').show().append('<p>' + decodeURIComponent(toFullName) + '</p>');

        // Add the card info to the card list to process later
        cardProperties = [donationID, 'cert02', 'certificate', toFullName, productURL, cardName, occasionType, thisSkew];

        $.fancybox.close();
        resetProducts();
        return;
      }

      return;
    }); //click
  } else if (card_form === "card01") {
    // Add occasion type to hidden input field for Satellite Data
    $("input[name='s_sat_card_occasion_type']").val(occasionType);

    $('#js-prod-personalizer h1').text('Customize Card');

    $('#card-form fieldset, .bottomButtons a').hide();

    $('fieldset.card01, #finishCard, .leaveBlank').show();

    $('.leaveBlank').click(function (e) {
      e.preventDefault();

      // Add the card info to the card list to process later
      cardProperties = [donationID, 'card-blank', cardName, occasionType, thisSkew];

      $.fancybox.close();
      resetProducts();
      return;

    }); //click

    $('#finishCard').click(function (e) {
      e.preventDefault();

      if (checkFields()) {
        toFirstName = $("input[name='MHFirst_X']").val();
        toMI = $("input[name='MHMI_X']").val() || false;
        toLastName = $("input[name='MHLast_X']").val();
        toFullName = "";
        toAddress1 = $("input[name='Address1_X']").val();
        toAddress2 = $("input[name='Address2_X']").val();
        toCity = $("input[name='City_X']").val();
        toState = $("select#State_X option:selected").val();
        toZip = $("input[name='PostalCode_X']").val();
        toCountry = $("select#Country_X option:selected").val();
        message = $("input[name='Custom10_X']").val() + " " + $("input[name='Custom11_X']").val() + " " + $("input[name='Custom12_X']").val();
        var msgLine1 = $("input[name='Custom10_X']").val();
        var msgLine2 = $("input[name='Custom11_X']").val();
        var msgLine3 = $("input[name='Custom12_X']").val();

        // Create full name from First, Middle, Last
        if (toMI) {
          toFullName = toFirstName + " " + toMI + " " + toLastName;
        } else {
          toFullName = toFirstName + " " + toLastName;
        }

        // Preview card
        $('.product-thumb').append('<img src="' + decodeURIComponent(cardImage1) + '" width="140">');
        $('#card_preview').show();
        $('#card_create').hide();
        $('#card_send_to').show().append(
          '<p>' + decodeURIComponent(toFullName) + '</p>' +
          '<p>' + decodeURIComponent(toAddress1) + '</p>' +
          '<p>' + decodeURIComponent(toAddress2) + '</p>' +
          '<p>' + decodeURIComponent(toCity) + '</p>' +
          '<p>' + decodeURIComponent(toState) + '</p>' +
          '<p>' + decodeURIComponent(toZip) + '</p>' +
          '<p>' + decodeURIComponent(toCountry) + '</p>'
        );
        $('#card_personal_message').show().append('<p>' + decodeURIComponent(message) + '</p>');

        // Add the card info to the card list to process later
        cardProperties = [donationID, 'card01', 'card', toFullName, toAddress1, toAddress2, toCity, toState, toZip, toCountry, productURL, message, cardName, msgLine1, msgLine2, msgLine3, occasionType, thisSkew];

        $.fancybox.close();
        resetProducts();
        return;
      }
    }); //click
  } else if (card_form === "card02") {
    // Add occasion type to hidden input field for Satellite Data
    $("input[name='s_sat_card_occasion_type']").val(occasionType);

    $('#js-prod-personalizer h1').text('Customize Card');

    $('#card-form fieldset, .bottomButtons a').hide();

    $('.card02, #finishCard, .leaveBlank').show();

    $('#from_info').html('Your name or family name will be printed on the card exactly as you type it here. Limit 40 characters including spaces.');

    $('.leaveBlank').click(function (e) {
      e.preventDefault();

      // Add the card info to the card list to process later
      cardProperties = [donationID, 'card-blank', cardName, occasionType, thisSkew];
      
      $.fancybox.close();
      resetProducts();
      return;

    }); //click

    $('#finishCard').click(function (e) {
      e.preventDefault();

      if (checkFields()) {
        toFirstName = $("input[name='MHFirst_X']").val();
        toMI = $("input[name='MHMI_X']").val() || false;
        toLastName = $("input[name='MHLast_X']").val();
        toFullName = "";
        toAddress1 = $("input[name='Address1_X']").val();
        toAddress2 = $("input[name='Address2_X']").val();
        toCity = $("input[name='City_X']").val();
        toState = $("select#State_X option:selected").val();
        toZip = $("input[name='PostalCode_X']").val();
        toCountry = $("select#Country_X option:selected").val();
        fromName = $("input[name='LastName_X']").val();


        // Create full name from First, Middle, Last
        if (toMI) {
          toFullName = toFirstName + " " + toMI + " " + toLastName;
        } else {
          toFullName = toFirstName + " " + toLastName;
        }

        // Preview card
        $('.product-thumb').append('<img src="' + decodeURIComponent(cardImage1) + '" width="140">');
        $('#card_preview').show();
        $('#card_create').hide();
        $('#card_send_to').show().append(
          '<p>' + decodeURIComponent(toFullName) + '</p>' +
          '<p>' + decodeURIComponent(toAddress1) + '</p>' +
          '<p>' + decodeURIComponent(toAddress2) + '</p>' +
          '<p>' + decodeURIComponent(toCity) + '</p>' +
          '<p>' + decodeURIComponent(toState) + '</p>' +
          '<p>' + decodeURIComponent(toZip) + '</p>' +
          '<p>' + decodeURIComponent(toCountry) + '</p>'
        );
        $('#card_from').show().append('<p>' + decodeURIComponent(fromName) + '</p>');

        // Add the card info to the card list to process later
        cardProperties = [donationID, 'card02', 'card', toFullName, toAddress1, toAddress2, toCity, toState, toZip, toCountry, fromName, productURL, cardName, occasionType, thisSkew];
        
        $.fancybox.close();
        resetProducts();
        return;
      }
    }); //click
  } else if (card_form === "card03") {
    // Add occasion type to hidden input field for Satellite Data
    $("input[name='s_sat_card_occasion_type']").val(occasionType);

    $('#js-prod-personalizer h1').text('Customize Card');

    $('#card-form fieldset, .bottomButtons a').hide(); 

    $('fieldset.card03, #finishCard, .leaveBlank').show();

    $('.leaveBlank').click(function (e) {
      e.preventDefault();

      // Add the card info to the card list to process later
      cardProperties = [donationID, 'card-blank', cardName, occasionType, thisSkew];
      
      $.fancybox.close();
      resetProducts();
      return;

    }); //click

    $('#finishCard').click(function (e) {
      e.preventDefault();
      if (checkFields()) {

        shippingFirstName = $("input[name='MHFirst_X']").val();
        shippingMI = $("input[name='MHMI_X']").val() || false;
        shippingLastName = $("input[name='MHLast_X']").val();
        toAddress1 = $("input[name='Address1_X']").val();
        toAddress2 = $("input[name='Address2_X']").val();
        toCity = $("input[name='City_X']").val();
        toState = $("select#State_X option:selected").val();
        toZip = $("input[name='PostalCode_X']").val();
        toCountry = $("select#Country_X option:selected").val();

        toFirstName = $("input[name='MemorialFirst_X']").val();
        toMI = $("input[name='MemorialMI_X']").val() || false;
        toLastName = $("input[name='MemorialLast_X']").val();
        toInHonorOf = $("input[name='MemorialName_X_v3']").val() || false;

        toFullName = "";
        shippingFullName = "";
        fromName = $("input[name='LastName_X']").val();

        // If the "In honor of" field is blank, create full name from First, Middle, Last
        if (!toInHonorOf) {
          if (toMI) {
            toFullName = toFirstName + "%20" + toMI + "%20" + toLastName;
          } else {
            toFullName = toFirstName + "%20" + toLastName;
          }
        } else {
          toFullName = toInHonorOf;
        }

        if (shippingMI) {
          shippingFullName = shippingFirstName + "%20" + shippingMI + "%20" + shippingLastName;
        } else {
          shippingFullName = shippingFirstName + "%20" + shippingLastName;
        }

        // Preview card
        $('.product-thumb').append('<img src="' + decodeURIComponent(cardImage1) + '" width="140">');
        $('#card_preview').show();
        $('#card_create').hide();
        $('#card_send_to').show().append(
          '<p>' + decodeURIComponent(shippingFullName) + '</p>' +
          '<p>' + decodeURIComponent(toAddress1) + '</p>' +
          '<p>' + decodeURIComponent(toAddress2) + '</p>' +
          '<p>' + decodeURIComponent(toCity) + '</p>' +
          '<p>' + decodeURIComponent(toState) + '</p>' +
          '<p>' + decodeURIComponent(toZip) + '</p>' +
          '<p>' + decodeURIComponent(toCountry) + '</p>'
        );
        $('#card_in_honor_of').show().append('<p>' + decodeURIComponent(toFullName) + '</p>');

       // Add the card info to the card list to process later
        cardProperties = [donationID, 'card03', 'card', toFullName, toAddress1, toAddress2, toCity, toState, toZip, toCountry, fromName, productURL, cardName, occasionType, thisSkew, shippingFirstName, shippingMI, shippingLastName];

        $.fancybox.close();
        resetProducts();
        return;
      }
    }); //click
  } else if (card_form === "card04") {
    // Add occasion type to hidden input field for Satellite Data
    $("input[name='s_sat_card_occasion_type']").val(occasionType);

    $('#js-prod-personalizer h1').text('Customize Card');

    $('#card-form fieldset, .bottomButtons a').hide(); 

    $('fieldset.card04, #finishCard, .leaveBlank').show();

    $('.leaveBlank').click(function (e) {
      e.preventDefault();
      
      // Add the card info to the card list to process later
      cardProperties = [donationID, 'card-blank', cardName, occasionType, thisSkew];
      
      $.fancybox.close();
      resetProducts();
      return;

    }); //click

    $('#finishCard').click(function (e) {
      e.preventDefault();
      if (checkFields()) {

        shippingFirstName = $("input[name='MHFirst_X']").val();
        shippingMI = $("input[name='MHMI_X']").val() || false;
        shippingLastName = $("input[name='MHLast_X']").val();
        toAddress1 = $("input[name='Address1_X']").val();
        toAddress2 = $("input[name='Address2_X']").val();
        toCity = $("input[name='City_X']").val();
        toState = $("select#State_X option:selected").val();
        toZip = $("input[name='PostalCode_X']").val();
        toCountry = $("select#Country_X option:selected").val();
        toFirstName = $("input[name='MemorialFirst_X']").val();
        toMI = $("input[name='MemorialMI_X']").val() || false;
        toLastName = $("input[name='MemorialLast_X']").val();
        toInHonorOf = $("input[name='MemorialName_X_v3']").val() || false; 
        toFullName = "";
        shippingFullName = "";
        fromName = $("input[name='LastName_X']").val();

        // If the "In honor of" field is blank, create full name from First, Middle, Last
        if (!toInHonorOf) {
          if (toMI) {
            toFullName = toFirstName + "%20" + toMI + "%20" + toLastName;
          } else {
            toFullName = toFirstName + "%20" + toLastName;
          }
        } else {
          toFullName = toInHonorOf;
        }

        if (shippingMI) {
          shippingFullName = shippingFirstName + "%20" + shippingMI + "%20" + shippingLastName;
        } else {
          shippingFullName = shippingFirstName + "%20" + shippingLastName;
        }

        // Preview card
        $('.product-thumb').append('<img src="' + decodeURIComponent(cardImage1) + '" width="140">');
        $('#card_preview').show();
        $('#card_create').hide();
        $('#card_send_to').show().append(
          '<p>' + decodeURIComponent(shippingFullName) + '</p>' +
          '<p>' + decodeURIComponent(toAddress1) + '</p>' +
          '<p>' + decodeURIComponent(toAddress2) + '</p>' +
          '<p>' + decodeURIComponent(toCity) + '</p>' +
          '<p>' + decodeURIComponent(toState) + '</p>' +
          '<p>' + decodeURIComponent(toZip) + '</p>' +
          '<p>' + decodeURIComponent(toCountry) + '</p>'
        );
        $('#card_in_memory_of').show().append('<p>' + decodeURIComponent(toFullName) + '</p>');
        $('#card_from').show().append('<p>' + decodeURIComponent(fromName) + '</p>');

       // Add the card info to the card list to process later
        cardProperties = [donationID, 'card04', 'card', toFullName, toAddress1, toAddress2, toCity, toState, toZip, toCountry, fromName, productURL, cardName, occasionType, thisSkew, shippingFirstName, shippingMI, shippingLastName];

        
        $.fancybox.close();
        resetProducts();
        return;
      }
    }); //click
  } else if (card_form === "ecard01" || card_form === "ecard02") {
    // Add occasion type to hidden input field for Satellite Data
    $("input[name='s_sat_ecard_occasion_type']").val(occasionType);

    $('#js-prod-personalizer h1').text('Customize E-Card');

    $('#card-form fieldset, .bottomButtons a').hide(); 

    if (card_form === "ecard01") {
      $('fieldset.ecard01, #finisheCard').show();
      $('#honor_info').html('Would you like a different name to appear in the ecard?');
    } else if (card_form === "ecard02") {
      $('fieldset.ecard02, #finisheCard').show();
      $('#memorial_info').html('Would you like a different name to appear in the ecard?');
    }    

    $('#from_info').html('Your name or family name will be printed on the card exactly as you type it here. Limit 40 characters including spaces.');

    $('#finisheCard').click(function (e) {
      e.preventDefault();      
      if (checkFields()) {
        toFirstName = encodeURIComponent($("input[name='MemorialFirst_X_v2']").val());
        toMI = encodeURIComponent($("input[name='MemorialMI_X']").val()) || false;
        toLastName = encodeURIComponent($("input[name='MemorialLast_X']").val());
        toInHonorOf = encodeURIComponent($("input[name='MemorialName_X']").val()) || false;
        toEmail = encodeURIComponent($("input[name='MHEMail_X']").val());
        toFullName = "";
        fromName = encodeURIComponent($("input[name='LastName_X']").val());
        message = encodeURIComponent($("textarea[name='Comments_X']").val());

        // If the "In honor of" field is blank, create full name from First, Middle, Last
        if (!toInHonorOf) {
          if (toMI) {
            toFullName = toFirstName + "%20" + toMI + "%20" + toLastName;
          } else {
            toFullName = toFirstName + "%20" + toLastName
          }
        } else {
          toFullName = toInHonorOf
        }

        // Preview card
        $('.product-thumb').append('<img src="' + decodeURIComponent(cardImage1) + '" width="140">');
        $('#card_preview').show();
        $('#card_create').hide();
        $('#card_to').show().append('<p>' + decodeURIComponent(toEmail) + '</p>');
        $('#card_from').show().append('<p>' + decodeURIComponent(fromName) + '</p>');
        $('#card_personal_message').show().append('<p>' + decodeURIComponent(message) + '</p>');

        // Add the card info to the card list to process later
        cardProperties = [donationID, 'ecard01','ecard', toFullName, toEmail, fromName, cardName, message, ecardID, productURL, cardName, occasionType, thisSkew];

        $.fancybox.close();
        resetProducts();
        return;
      }
    });
  }

    return;
  }

  // If the "Back to Selection" button is clicked, go to step 1
  $('.middle-actions .back-btn').click(function (e) {
    e.preventDefault();
    showStep1();
  });

  // Function returns string encrypted
  function escapeAll(e) {
    var t = "";
    for (var n in e) {
      n = e.charAt(n);
      for (i = 0; i <= 256; ++i) {
        var r = i.toString(16);
        if (r.length == 1) r = "0" + r;
        r = "%" + r;
        if (unescape(r) == n) {
          t += r;
          break
        } else if (i == 256) {
          t += escape(n);
          break
        }
      }
    }
    return t
  }

  getDonationInfo = function () {
    var donations = mawf.CartView.donations();
    console.log("Donations: " + donations.toString());
    var monthly = false;
    var totalGift = 0.00;
    var x = 1;

    var bitlyURL = "";

    function get_short_url(long_url) {
      var returnURL = "";

      $.ajax({
        async: false, //thats the trick
        url: 'https://api-ssl.bitly.com/v3/shorten?format=json',
        dataType: 'json',
        data: {
          "format": "json",
          "apiKey": "R_50a44d5e5edc4dacaccb0841183fd8ce",
          "login": "wishamerica",
          "longUrl": long_url
        },
        success: function (response) {
          returnURL = response['data']['url'];
          console.log(returnURL);
        }
      });

      return returnURL;
    }

    for (var i in donations) {
      var chid = donations[i].donorIntent();
      var amnt = parseFloat(donations[i].prettyDonationAmount());
      var type = donations[i].donationType();
      var officeID;

      if($("input[name='s_sat_skew']").val() === '') {
        if(type === 1){
          $("input[name='s_sat_skew']").val('DO02-01');
        } else if(type === 2) {
          $("input[name='s_sat_skew']").val('MG05-01');
        } else {
          console.log('error: s_sat_skew is blank but was not set');
        }
      } else {
        console.log('s_sat_skew should be an hon/mem id');
      } 

      // BDC 12/10/2013
      var short_chid = chid.substr(0,3),
        form_chid = $('.logo a').attr('href').match(/\d+/)[0],
        donation_form_id = ( (parseInt(short_chid) < 500) ? ($(center_forms).find('office#' + short_chid + ' + form').attr('id')) : ('1563')),
        isMonthly = false,
        formDesignee = ( (parseInt(short_chid) < 500) ? ($(center_forms).find('office#' + short_chid).parent().attr('name')) : ('Make-A-Wish® International'));

      console.log(short_chid);

      data = data.replace(/form_id=\d{4}/,'form_id=' + donation_form_id);
      data += '&s_chid=' + chid + '&s_formDesignee=' + encodeURIComponent(formDesignee);

      if($('#monthlyGift.selected').length > 0) {
        isMonthly = true;
      }

      $('#foreign_key1').val(metadata_campaign_id);
      if(chid.substr(4,3) == '000') {
        $('#foreign_key2').val('UR-' + chid.substr(0,3) + '-01');
      }
      else {
        $('#foreign_key2').val('UR-' + chid + '-F');
      }
      $('#foreign_key5').val(metadata_subtype);

      if( form_chid === '100' ) {
        if( short_chid === '100' ) {
          // National form, national donation
          if($('#foreign_key3').val() === ''){
            $('#foreign_key3').val(metadata_appeal_year + '-NSP-' + (isMonthly ? metadata_national_monthly : metadata_national_office_code) );
          }
          if($('#foreign_key4').val() === ''){
            $('#foreign_key4').val('ON-' + metadata_national_office_code + '-' + form_chid);
          }
        }
        else {
          // National form, chapter donation
          if($('#foreign_key3').val() === ''){
            $('#foreign_key3').val(metadata_appeal_year + '-82S-' + (isMonthly ? metadata_national_monthly : metadata_national_office_code) );
          }
          if($('#foreign_key4').val() === ''){
            $('#foreign_key4').val('ON-' + metadata_national_office_code + '-' + form_chid);
          }
        }
      }
      else {
        if( form_chid === short_chid ) {
          // Chapter form, same chapter
          if($('#foreign_key3').val() === ''){
            $('#foreign_key3').val(metadata_appeal_year + '-NSP-' + (isMonthly ? metadata_chapter_monthly : metadata_chapter_office_code) );
          }
          if($('#foreign_key4').val() === ''){
            $('#foreign_key4').val('ON-' + metadata_chapter_office_code + '-' + form_chid);
          }
        }
        else {
          // Chapter form, different chapter
          if($('#foreign_key3').val() === ''){
            $('#foreign_key3').val(metadata_appeal_year +'-82S-' + (isMonthly ? metadata_chapter_monthly : metadata_chapter_office_code) );
          }
          if($('#foreign_key4').val() === ''){
            $('#foreign_key4').val('ON-'+ metadata_chapter_office_code + '-' + form_chid);
          }
        }
      }

      $('#source').val($('#foreign_key2').val() + ',' + $('#foreign_key3').val() + ',' + $('#foreign_key4').val())


      // If donation type is 2, this is a monthly gift
      if (type == 2) {
        monthly = true;
      }

      // Add this donation amount to the total
      totalGift += amnt;

    } // for loop

    if (monthly) {
      data = data + "&sustaining.frequency=monthly&sustaining.duration=0";
    }

    data = data + "&remember_me=true&other_amount=" + totalGift;

    var today = Date.today().toString('M/dd/yyyy') || "8/20/2013";
    var e = true;

    if (cardProperties[1] == 'ecard01') {
      var ecard_first_name = $("input[name='billing.name.first']").val()
      var ecard_last_name = $("input[name='billing.name.last']").val()
      var ecard_sender_email = $("input[name='donor.email']").val()
      var ecard_recipient_name = cardProperties[3];
      var ecard_recipient_email = cardProperties[4];
      var ecard_stationary_id = cardProperties[8];
      var ecard_subject = ecard_first_name + " " + ecard_last_name + " has sent you an e-card";
      var ecard_message = cardProperties[7];
      var honoreeProduct = cardProperties[9];
      var occassionType = cardProperties[11];
      var prodSkew = cardProperties[12];

      var prodURL = 'https://secure2.convio.net/wish/site/Ecard?ecard_id=1061&ecard_form=true&cons_info_component=t&cons_first_name=' + ecard_first_name + '&cons_last_name=' + ecard_last_name + '&cons_email=' + ecard_sender_email + '&cons_mail_opt_in=t&cons_email_opt_in=on&cons_email_opt_in_requested=true&s_rememberMe=on&sendtoemail=' + ecard_recipient_email + '&stationery_layout_chooser=true&stationery_layout_id=' + ecard_stationary_id + '&subject=' + ecard_subject + '&message=' + ecard_message + '&taf_send=Send+eCard++&denySubmit=&pgwrap=n';

      data = data + "&product_1_honoree_name=" + ecard_recipient_name + "&product_1_honoree_message=" + encodeURIComponent(ecard_message) + "&product_1_honoree_email=" + encodeURIComponent(ecard_recipient_email) + "&product_url_1=" + encodeURIComponent(honoreeProduct) + "&s_productURL1=" + encodeURIComponent(prodURL);

    } else if (cardProperties[1] == 'cert01' || cardProperties[1] == 'cert03') {
      var honoreeName = cardProperties[3];
      var productFromName = cardProperties[4];
      var honoreeProduct = cardProperties[5];
      var honoreeProductName = cardProperties[6];
      var occassionType = cardProperties[7];
      var prodSkew = cardProperties[8];
      var prodURL = "http://site.wish.org/site/PageNavigator/products.html?key=" + today + "&pdf=" + honoreeProduct + "&HonorName=" + encodeURIComponent(honoreeName) + "&DonorName=" + encodeURIComponent(productFromName);

      bitlyURL = get_short_url(prodURL);

      data = data + "&product_1_honoree_name=" + honoreeName + "&product_url_1=" + bitlyURL + "&s_productURL1=" + encodeURIComponent(prodURL) + "&s_productURL1Name=" + encodeURIComponent(honoreeProductName);

    } else if (cardProperties[1] == 'cert02') {
      var honoreeName = cardProperties[3];
      var honoreeProduct = cardProperties[4];
      var honoreeProductName = cardProperties[5];
      var occassionType = cardProperties[6];
      var prodSkew = cardProperties[7];
      var prodURL = "http://site.wish.org/site/PageNavigator/products.html?key=" + today + "&pdf=" + honoreeProduct + "&HonorName=" + encodeURIComponent(honoreeName);

      bitlyURL = get_short_url(prodURL);

      data = data + "&product_1_honoree_name=" + honoreeName + "&product_url_1=" + bitlyURL + "&s_productURL1=" + encodeURIComponent(prodURL) + "&s_productURL1Name=" + encodeURIComponent(honoreeProductName);

    } else if (cardProperties[1] == 'card01') {
      var honoreeName = cardProperties[3];
      var honoreeAdd1 = cardProperties[4];
      var honoreeAdd2 = cardProperties[5];
      var honoreeCity = cardProperties[6];
      var honoreeState = cardProperties[7];
      var honoreeZip = cardProperties[8];
      var honoreeCountry = cardProperties[9];
      var honoreeProduct = cardProperties[10];
      var honoreeMessage = cardProperties[11];
      var honoreeProductName = cardProperties[12];
      var prodMsgLine1 = cardProperties[13];
      var prodMsgLine2 = cardProperties[14];
      var prodMsgLine3 = cardProperties[15];
      var occassionType = cardProperties[16];
      var prodSkew = cardProperties[17];

      var prodURL = "http://site.wish.org/site/PageNavigator/products.html?key=" + today + "&pdf=" + honoreeProduct + "&HonorName=" + encodeURIComponent(honoreeName) + "&line1=" + encodeURIComponent(prodMsgLine1) + "&line2=" + encodeURIComponent(prodMsgLine2) + "&line3=" + encodeURIComponent(prodMsgLine3);

      bitlyURL = get_short_url(prodURL);

      data = data + "&product_1_honoree_name=" + honoreeName + "&product_1_honoree_address1=" + honoreeAdd1 + "&product_1_honoree_address2=" + honoreeAdd2 + "&product_1_honoree_city=" + honoreeCity + "&product_1_honoree_state=" + honoreeState + "&product_1_honoree_zip=" + honoreeZip + "&product_1_honoree_country=" + honoreeCountry + "&product_url_1=" + bitlyURL + "&s_productURL1=" + encodeURIComponent(prodURL) + "&product_1_honoree_message=" + honoreeMessage + "&s_productURL1Name=" + encodeURIComponent(honoreeProductName);

    } else if (cardProperties[1] == 'card02') {
      var honoreeName = cardProperties[3];
      var honoreeAdd1 = cardProperties[4];
      var honoreeAdd2 = cardProperties[5];
      var honoreeCity = cardProperties[6];
      var honoreeState = cardProperties[7];
      var honoreeZip = cardProperties[8];
      var honoreeCountry = cardProperties[9];
      var productFromName = cardProperties[10];
      var honoreeProduct = cardProperties[11];
      var honoreeProductName = cardProperties[12];
      var occassionType = cardProperties[13];
      var prodSkew = cardProperties[14];

      var prodURL = "http://site.wish.org/site/PageNavigator/products.html?key=" + today + "&pdf=" + honoreeProduct + "&HonorName=" + encodeURIComponent(honoreeName) + "&DonorName=" + encodeURIComponent(productFromName);

      bitlyURL = get_short_url(prodURL);

      data = data + "&product_1_honoree_name=" + honoreeName + "&product_1_honoree_address1=" + honoreeAdd1 + "&product_1_honoree_address2=" + honoreeAdd2 + "&product_1_honoree_city=" + honoreeCity + "&product_1_honoree_state=" + honoreeState + "&product_1_honoree_zip=" + honoreeZip + "&product_1_honoree_country=" + honoreeCountry + "&product_url_1=" + bitlyURL + "&s_productURL1=" + encodeURIComponent(prodURL) + "&s_productURL1Name=" + encodeURIComponent(honoreeProductName);

    } else if (cardProperties[1] == 'card03' || cardProperties[1] == 'card04') {

      var honoreeName = cardProperties[3];
      var honoreeAdd1 = cardProperties[4];
      var honoreeAdd2 = cardProperties[5];
      var honoreeCity = cardProperties[6];
      var honoreeState = cardProperties[7];
      var honoreeZip = cardProperties[8];
      var honoreeCountry = cardProperties[9];
      var productFromName = cardProperties[10];
      var honoreeProduct = cardProperties[11];
      var honoreeProductName = cardProperties[12];
      var occassionType = cardProperties[13];
      var prodSkew = cardProperties[14];
      var shippingNameFirst = cardProperties[15];
      var shippingNameMiddle = cardProperties[16];
      var shippingNameLast = cardProperties[17];

      var prodURL = "http://site.wish.org/site/PageNavigator/products.html?key=" + today + "&pdf=" + honoreeProduct + "&HonorName=" + encodeURIComponent(honoreeName) + "&DonorName=" + encodeURIComponent(productFromName);

      bitlyURL = get_short_url(prodURL);

      data = data + "&product_1_honoree_name=" + honoreeName + "&product_1_honoree_address1=" + honoreeAdd1 + "&product_1_honoree_address2=" + honoreeAdd2 + "&product_1_honoree_city=" + honoreeCity + "&product_1_honoree_state=" + honoreeState + "&product_1_honoree_zip=" + honoreeZip + "&product_1_honoree_country=" + honoreeCountry + "&product_url_1=" + bitlyURL + "&s_productURL1=" + encodeURIComponent(prodURL) + "&s_productURL1Name=" + encodeURIComponent(honoreeProductName) + "&shipping.name.first=" + shippingNameFirst + "&shipping.name.middle=" + shippingNameMiddle + "&shipping.name.last=" + shippingNameLast;

    } else if (cardProperties[1] == "card-blank") {
      var honoreeProductName = cardProperties[2];
      var occassionType = cardProperties[3];
      var prodSkew = cardProperties[4];
      data = data + "&product_url_1=blank&s_productURL1=blank&s_productURL1Name=" + encodeURIComponent(honoreeProductName);

    }

    if (data.indexOf("product_url_1") == -1) {
      data = data + "&product_url_1=none&s_productURL1=none&s_productURL1Name=none";
    }

    console.log("Data: " + data);
  } // getDonationInfo()

});
</script>

<script src="../assets/js/config.js" type="text/javascript"></script>
<script type="text/javascript" src="../assets/js/jquery.json-2.4.min.js"></script>
<script type="text/javascript" src="../assets/js/jstorage.js"></script>
<script src="../assets/js/jquery.uniform.js" type="text/javascript"></script>
<script src="../assets/js/date.js" type="text/javascript"></script>
<script src="../assets/js/form-validater.js" type="text/javascript"></script>
<script type="text/javascript"> var mawf = mawf || {}; mawf.validation_errors = {"js_name":{"errorEmpty":"Oops! Please enter a name.","errorInvalid":null},"js_site":{"errorEmpty":"Oops! Please enter a url.","errorInvalid":null},"js_mname":{"errorEmpty":"Oops! Please enter a wedding couple name.","errorInvalid":null},"js_fname":{"errorEmpty":"Oops! Please enter a first name.","errorInvalid":null},"js_fname_dependency":{"errorEmpty":"Oops! Please enter a first name.","errorInvalid":null},"js_lname":{"errorEmpty":"Oops! Please enter a last name.","errorInvalid":null},"js_fname-legacy":{"errorEmpty":"Oops! Please enter a first name.","errorInvalid":null},"js_address":{"errorEmpty":"Oops! Please enter an address.","errorInvalid":null},"js_city":{"errorEmpty":"Oops! Please enter a city.","errorInvalid":null},"js_state":{"errorEmpty":"Oops! Please select a state.","errorInvalid":"Oops! State is not appropriate for your country choice."},"js_stateonly":{"errorEmpty":"Oops! Please select a state.","errorInvalid":null},"js_zip":{"errorEmpty":"Oops! Please enter a postal code.","errorInvalid":"Oops! Please enter a valid postal code."},"js_ifMailCheckbox":{"errorEmpty":"Oops! This field is now required.","errorInvalid":null},"js_isZip":{"errorEmpty":null,"errorInvalid":"Oops! Please enter a valid postal code."},"js_ziponly":{"errorEmpty":"Oops! Please enter a postal code.","errorInvalid":"Oops! Please enter a valid postal code."},"js_legacyFor":{"errorEmpty":"Oops! Please select one.","errorInvalid":null},"js_country":{"errorEmpty":"Oops! Please select a country.","errorInvalid":"Oops! Please select a valid country."},"js_phone":{"errorEmpty":"Oops! Please enter a valid phone number.","errorInvalid":"Oops! Please enter a valid phone number."},"js_quesCom":{"errorEmpty":"Oops! Please enter a question or comment.","errorInvalid":null},"js_relationship":{"errorEmpty":"Oops! Please select your relationship. ","errorInvalid":null},"js_wishtitle":{"errorEmpty":"Oops! Please include a headline.","errorInvalid":null},"js_wishstory":{"errorEmpty":"Oops! Please include body text to explain how the story impacted yourself or others.","errorInvalid":null},"js_storyAgeCheck":{"errorEmpty":null,"errorInvalid":"Oops! If you are under 13 years of age, please ask your parent or guardian to share your story with us."},"js_org":{"errorEmpty":"Oops! Please enter the name of your company.","errorInvalid":null},"js_companydesc":{"errorEmpty":"Oops! Please select a company description.","errorInvalid":null},"js_size":{"errorEmpty":"Oops! Please select a company size.","errorInvalid":null},"js_companyGiving":{"errorEmpty":"Oops! Please indicate either yes or no.","errorInvalid":null},"js_msg1":{"errorEmpty":null,"errorInvalid":"Oops! This message is longer than 53 characters."},"js_text1":{"errorEmpty":null,"errorInvalid":"Oops! The personal message can only be 370 characters long. Please shorten your message."},"js_picture":{"errorEmpty":"Oops! Please submit a picture.","errorInvalid":"Oops! Please select an image file."},"js_email":{"errorEmpty":"Oops! Please enter a valid email address.","errorInvalid":"Oops! Please enter a valid email address."},"js_emailOptional":{"errorEmpty":"Oops! Please enter a valid email address.","errorInvalid":"Oops! Please enter a valid email address."},"js_emailCompare":{"errorEmpty":"Oops! Please enter an email address that matches the above email address.","errorInvalid":"Oops! Please enter an email address that matches the above email address."},"js_emailOptionalCompare":{"errorEmpty":"Oops! Please enter an email address that matches the above email address.","errorInvalid":"Oops! Please enter an email address that matches the above email address."},"js_donationAmount":{"errorEmpty":"Oops! Please enter a donation amount.","errorInvalid":null},"js_donationDest":{"errorEmpty":"Oops! Please enter a donation destination.","errorInvalid":"No matching results found!"},"js_donationDest-legacy":{"errorEmpty":"Oops! Please enter a donation destination.","errorInvalid":"No matching results found!"},"js_url":{"errorEmpty":"Oops! Please enter a URL.","errorInvalid":"Oops! Please enter a valid URL."},"js_selectreq":{"errorEmpty":"Oops! Please select one.","errorInvalid":null},"js_milesacct":{"errorEmpty":"Oops! Please enter your airline account digits.","errorInvalid":null},"js_ccFName":{"errorEmpty":"Oops! Card holder's name is required.","errorInvalid":null},"js_ccNumber":{"errorEmpty":"Oops! Please enter a valid credit card number.","errorInvalid":"Oops! Please enter a valid credit card number."},"js_ccSecNumber":{"errorEmpty":"Oops! Please enter a security number.","errorInvalid":"Oops! Please enter a valid security number."},"js_ccExpMonth":{"errorEmpty":"Oops! Please select a valid expiration month.","errorInvalid":"Oops! Please select a valid expiration month."},"js_ccExpYear":{"errorEmpty":"Oops! Please select a valid expiration year.","errorInvalid":"Oops! Please select a valid expiration year."},"js_milesdonate":{"errorEmpty":"Oops! Please enter a valid number of miles.","errorInvalid":"Oops! Please enter a valid number of miles."},"js_topQuestion":{"errorEmpty":"Oops! Please select an area of interest.","errorInvalid":null},"js_agecheck":{"errorEmpty":null,"errorInvalid":"Oops! You must be at least 13 years old to receive newsletters."},"js_optIn":{"errorEmpty":"Oops! Please select which newsletters you with to receive.","errorInvalid":null},"js_selectOneGeneric":{"errorEmpty":"Oops! Please select one.","errorInvalid":null},"js_selectBool":{"errorEmpty":"Oops! Please choose yes or no.","errorInvalid":null},"js_airmilesDonated":{"errorEmpty":"Oops! Please enter a valid number of miles.","errorInvalid":null},"js_airmilesAccount":{"errorEmpty":"Oops! Please enter your airline account digits.","errorInvalid":null},"js_categoryGeneric":{"errorEmpty":"Oops! Please choose one category.","errorInvalid":null},"js_organization":{"errorEmpty":"Oops! Please enter your organization name.","errorInvalid":null},"js_company":{"errorEmpty":"Oops! Please enter the name of your company.","errorInvalid":null},"js_position":{"errorEmpty":"Oops! Please enter your position.","errorInvalid":null},"js_headline":{"errorEmpty":"Oops! Please include a headline.","errorInvalid":null},"js_storyBody":{"errorEmpty":"Oops! Please include body text to explain how the story impacted yourself or others.","errorInvalid":null},"js_recognition":{"errorEmpty":"Oops! Please enter your name unless you wish to remain anonymous.","errorInvalid":null},"js_fname-pers":{"errorEmpty":"Oops! First name is required.","errorInvalid":null},"js_lname-pers":{"errorEmpty":"Oops! Last name is required.","errorInvalid":null},"js_fname-pers2":{"errorEmpty":"Oops! First name is required.","errorInvalid":null},"js_lname-pers2":{"errorEmpty":"Oops! Last name is required.","errorInvalid":null},"js_SITReq":{"errorEmpty":"Oops! Please select at least one.","errorInvalid":null},"js_airYear":{"errorEmpty":null,"errorInvalid":"Oops! Please select a valid date."},"js_airMonth":{"errorEmpty":null,"errorInvalid":"Oops! Please select a valid date."},"js_airDay":{"errorEmpty":null,"errorInvalid":"Oops! Please select a valid date."},"js_fname1":{"errorEmpty":"Oops! Please enter a first name.","errorInvalid":null},"js_lname1":{"errorEmpty":"Oops! Please enter a last name.","errorInvalid":null},"js_donationToCountry":{"errorEmpty":null,"errorInvalid":"No matching results found!"},"js_genericChapLoc":{"errorEmpty":"Oops! Please select a valid chapter.","errorInvalid":"No matching results found!"}}</script>
<script type="text/javascript"> var mawf = mawf || {}; mawf.transactional_errors = {"genericContactUs":"If you continue to receive this error message, please contact the bank that issued the card. You may also call us at 1-866-880-1382 to make your donation by phone.","decline":"Oops! Your credit card has been declined. Please enter a different credit card number and try again.","invalid_number":"Oops! You have entered an invalid credit card number.  Please enter a different credit card number and try again.","invalid_exp":"Oops! You have entered an invalid expiration date.  Please check the date, re-enter it and try again.","invalid_csc":"Oops! Your credit card security code is invalid.  Please re-enter it and try again.","amount_0":"Oops! We encountered a problem processing your donation.  Please start again.","clearTokenAndReset":"Oops! We encountered a problem processing your donation.  Please start again.","processing_incomplete":"Oops! We encountered a problem processing your donation.  Please try submitting it again.","timeout":"Oops! We encountered a problem processing your donation.  Please try submitting it again."}</script>
<script src="../assets/js/jquery.cookie.js" type="text/javascript"></script>
<script src="../assets/js/jquery-placeholder.js" type="text/javascript"></script>
<script src="../assets/js/jquery.fancybox.js" type="text/javascript"></script>
<script src="../assets/js/jquery.qtip.min.js" type="text/javascript"></script>
<script src="../assets/js/swfobject.js" type="text/javascript"></script>
<script src="../assets/js/waypoints.js" type="text/javascript"></script>
<script src="../assets/js/jquery.scrollTo.js" type="text/javascript"></script>
<script src="../assets/js/jquery.imagesloaded.min.js" type="text/javascript"></script>
<script src="../assets/js/jquery.mawsocial.js" type="text/javascript"></script>
<script src="../assets/js/global.js" type="text/javascript"></script>
<script src="../assets/js/wishes.js" type="text/javascript"></script>
<script src="../assets/js/home.js" type="text/javascript"></script>
<script src="../assets/js/custom-select-menu.jquery.js"></script>
<script src="../assets/js/leave-comment.js" type="text/javascript"></script>
<script defer src="https://www.youtube.com/player_api" type="text/javascript"></script>
<script src="../assets/js/addthis.js" type="text/javascript"></script>
<script src="../assets/js/rot.js" type="text/javascript"></script>

<!-- DONATION SPECIFIC JS -->
<script type='text/javascript' src='../assets/js/knockout-latest.js'></script>
<script src="../assets/js/ko-custom.concat.js?14" type="text/javascript"></script>
<script>
// Get chapter info from JSON file
chaptersjson = (function () {
  var json = null;
  $.ajax({
    'async': false,
    'global': false,
    'url': 'https://secure2.convio.net/wish/assets/js/chapters.json',
    'dataType': "json",
    'success': function (data) {
      json = data;
    }
  });
  return json;
})();

(function ($) {
  $('a.checkDonations').click(function (e) {
    var donations = mawf.CartView.donations()
    e.preventDefault();
    console.log(donations.length + ' donations.');
    for (var i in donations) {
      console.log(donations[i]);
      console.log(donations[i].donationID());
    }
    getDonationInfo();
  });

  function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
      vars[key] = value;
    });
    return vars;
  }

  var urlVariableArray = getUrlVars();

  for (var index in urlVariableArray) {
    if (index.substring(0, 2) == "s_") {
      data = data + "&" + index + "=" + urlVariableArray[index];
    }
  }

  var level1 = getUrlVars()["level1"];
  var level2 = getUrlVars()["level2"];
  var level3 = getUrlVars()["level3"];
  var level4 = getUrlVars()["level4"];
  var level5 = getUrlVars()["level5"];
  var level6 = getUrlVars()["level6"];
  var level7 = getUrlVars()["level7"];
  var chid = '[[S80:chid]]';
  var chapter_prefix = chid.substring(0, 3);

  if (level1 < 1 || isNaN(level1)) {
    level1 = 30;
  } else {
    level1 = Math.floor(level1);
  }

  if (level2 < 1 || isNaN(level2)) {
    level2 = 50;
  } else {
    level2 = Math.floor(level2);
  }

  if (level3 < 1 || isNaN(level3)) {
    level3 = 100;
  } else {
    level3 = Math.floor(level3);
  }

  if (level4 < 1 || isNaN(level4)) {
    level4 = 150;
  } else {
    level4 = Math.floor(level4);
  }

  if (level5 < 1 || isNaN(level5)) {
    level5 = 250;
  } else {
    level5 = Math.floor(level5);
  }

  if (level6 < 1 || isNaN(level6)) {
    level6 = 500;
  } else {
    level6 = Math.floor(level6);
  }

  if (level7 < 1 || isNaN(level7)) {
    level7 = 1000;
  } else {
    level7 = Math.floor(level7);
  }

  numLevels = $('.ammount-btn').length;

  if (numLevels > 3) {
    $('.donate-wrap .other').css("float", "left");
    $('.donate-wrap .ammount-btn').css("margin-bottom", "10px");
  }

  if (chid && chid != "100-000") {

    var orgChapterName = "";
    var orgCenter = "";

    $(chaptersjson['allChapters']['chapter']).each(function (index, arr) {
      if (arr['office_id'] == chid) {
        orgChapterName = arr['office_name'];
        orgCenter = arr['center_id'];
        mawf.donation_init({
          localizedCurrencySymbol: '$',
          donorIntentId: chid,
          donorIntentName: orgChapterName,
          donationType1Label: 'A Single Donation',
          donationType2Label: 'A Monthly Pledge',
          minimumDonation: '5',
          donationAmt1: level1,
          donationAmt2: level2,
          donationAmt3: level3,
          donationAmt4: level4,
          donationAmt5: level5,
          donationAmt6: level6,
          donationAmt7: level7,
          startDate1: 5,
          startDate2: 20,
          clearFormMessage: 'Clearing the form will remove all your entered information. Are you sure you wish to proceed?',
          clearFormBtnYes: 'Yes, clear form',
          clearFormBtnNo: 'No, take me back to the form',
          nationalID: '100-000',
          nationalName: 'Make-A-Wish® America',
          internationalID: '500-000',
          internationalName: 'Make-A-Wish® International',
          purchaserID: chid,
          purchaserName: orgChapterName,
          sitChapterID: chid,
          sitChapter: orgChapterName,
          sitCenter: orgCenter
        });
        return false;
      }
    });

  } else {
    mawf.donation_init({
      localizedCurrencySymbol: '$',
      donorIntentId: '100-000',
      donorIntentName: 'Make-A-Wish® America',
      donationType1Label: 'A Single Donation',
      donationType2Label: 'A Monthly Pledge',
      minimumDonation: '5',
      donationAmt1: level1,
      donationAmt2: level2,
      donationAmt3: level3,
      donationAmt4: level4,
      donationAmt5: level5,
      donationAmt6: level6,
      donationAmt7: level7,
      startDate1: 5,
      startDate2: 20,
      clearFormMessage: 'Clearing the form will remove all your entered information. Are you sure you wish to proceed?',
      clearFormBtnYes: 'Yes, clear form',
      clearFormBtnNo: 'No, take me back to the form',
      nationalID: '100-000',
      nationalName: 'Make-A-Wish® America',
      internationalID: '500-000',
      internationalName: 'Make-A-Wish® International',
      purchaserID: '100-000',
      purchaserName: 'Make-A-Wish® America',
      sitChapterID: '100-000',
      sitChapter: 'Make-A-Wish® America',
      sitCenter: '1001'
    });
  }

  if (chid && chid != "100-000") {
    $('#localOptin').insertBefore('#nationalOptin');
    $('.intouch-container:eq(0)').addClass('selected');
    $('.intouch-container:eq(0) input').prop('checked', true);
    console.log('chid is set to: ' + chid);
    $("input[name='s_sat_chapter_id']").val(chid);
  } else {
    console.log('chid is not set');
    $("input[name='s_sat_chapter_id']").val("100-000");
  }

  data = 'method=donate&form_id=1420';

  $('.sendCards').click(function (e) {
    e.preventDefault();
    sendCards();
  });

  function getNextMonth() {
    var dayOfMonth = Date.today().toString('d');

    if (dayOfMonth == '29' || dayOfMonth == '30' || dayOfMonth == '31') {
      return Date.today().moveToFirstDayOfMonth().addMonths(2).toString('M/d/yyyy');
    } else {
      return Date.today().next().month().toString('M/d/yyyy');
    }
  }

  $('.nextMonth').each(function () {
    $(this).append(getNextMonth());
  });

  var searchForChapters = function(search_value, local_or_international){
    $('ul.search-menu').html('<li id="no_valid_region"><a>Matching Result Not Found!</a></li>');
    if(parseInt(search_value)) {
      $.getJSON('../assets/js/zip-codes.json', function (data) {
        $(data['chapter']).each(function (index, arr) {
          var chapter_id = arr['chapter_id'];
          if (arr['zip_code'] == search_value) {
            $(chaptersjson['allChapters']['chapter']).each(function (index, arr) {
              if(local_or_international == 'local'){
                if(parseInt(chapter_id.substr(0,3)) < 500) {
                  if (arr['office_id'] == chapter_id) {
                    $('ul.search-menu').html('<li><a href="#" data-office-id="' + chapter_id + '" class="chapter-btn">' + arr['office_name'] + '</a></li>');
                    window.formFundID = arr['fund_id'];
                    return;
                  }
                }
              } else {
                if(parseInt(chapter_id.substr(0,3)) >= 500) {
                  if (arr['office_id'] == chapter_id) {
                    $('ul.search-menu').html('<li><a href="#" data-office-id="' + chapter_id + '" class="chapter-btn">' + arr['office_name'] + '</a></li>');
                    window.formFundID = arr['fund_id'];
                    return;
                  }
                }
              }
            });
          }
        });
      });
    } else {
      if (search_value.length > 2) {
        $(chaptersjson['allChapters']['chapter']).each(function (index, arr) {
          var office_name_regex = new RegExp(search_value,'i'),
          chapter_id = arr['office_id'];
          if(local_or_international == 'local'){
            if(parseInt(chapter_id.substr(0,3)) < 500) {
              if(office_name_regex.test(arr['office_name'])) {
                $('#no_valid_region').remove();
                $('ul.search-menu').html($('ul.search-menu').html() + '<li><a href="#" data-office-id="' + chapter_id + '" class="chapter-btn">' + arr['office_name'] + '</a></li>');
              }
            }
          } else {
            if(parseInt(chapter_id.substr(0,3)) >= 500) {
              if(office_name_regex.test(arr['office_name'])) {
                $('#no_valid_region').remove();
                $('ul.search-menu').html($('ul.search-menu').html() + '<li><a href="#" data-office-id="' + chapter_id + '" class="chapter-btn">' + arr['office_name'] + '</a></li>');
              }
            }
          }
        });
      }
    }
  };

  $(document).on('keyup', '.js_donationDest', function (e) {
    searchForChapters($(this).val(), 'local');
  });
  $(document).on('keyup', '.js_donationToCountry', function (e) {
    searchForChapters($(this).val(), 'international');
  });

  $('a.state-btn').click(function (e) {
    e.preventDefault();
    var state = $(this).text();
    var stateResults = [];
    var $chapterResults = $('.js-chapter-results ul');
    $chapterResults.html('');

    $(chaptersjson['allChapters']['chapter']).each(function (index, arr) {
      if (arr['state_province'] == state) {
        stateResults.push([arr['office_id'], arr['office_name']])
      }
    }); //each loop

    for (var i = 0; i < stateResults.length; i++) {
      var stateResult = stateResults[i]
      $chapterResults.append('<li><a class="chapter-btn" data-office-id="' + stateResult[0] + '" href="#" >' + stateResult[1] + '</a></li>');
    }
  });
})(jQuery);
</script>

<script type='text/javascript' src='../assets/js/bootstrap-typeahead.js'></script>
<script type="text/javascript" src="../assets/js/luminateExtend.js"></script>

<script>
luminateExtend.init({
  apiKey: 'mu3fefod',
  path: {
    nonsecure: 'http://site.wish.org/site/',
    secure: 'https://secure2.convio.net/wish/site/'
  }
});

var xmlHttp = new XMLHttpRequest();

function showError(pageError, fieldError) {

  alert(pageError + " " + fieldError);
  $("a.button-submit").css("cursor", "pointer").removeClass("disabled").removeAttr("disabled");
  console.log(pageError + " " + fieldError);
}

var addCentersCallback = function (data) {
  console.log("Add Centers Callback: " + data);

};

var addCentersCallbackLast = function (data) {
  console.log("Add Centers Callback Last: " + data);
  lastStep();
};

function lastStep() {
  console.log("last step");
  $.removeCookie("cart");
  $.jStorage.flush();
  localStorage.clear();
  savedSession = {}
  $("#mainform input").each(function () {
    $(this).val("");
  });

  window.onbeforeunload = function () {};

  if(isPaypal) {
    window.location = window.paypalRedirectUrl;
  }
  else {
    window.location = "https://secure2.convio.net/wish/site/SPageServer?pagename=donate_thankyou";
  }
}

$('#ccPostal').blur(function(e){
  var id_from_billing_zip;  

  $(zip_array['chapter']).each(function (index, arr) {
    if (arr['zip_code'] == $('#ccPostal').val()) {
      id_from_billing_zip = arr['chapter_id'];
      
      $('#chapter_id').val(id_from_billing_zip);
    } 
  });  
  
});

function finishGift() {
  console.log("finish gift");
  var survey_ids = [];

  if ($('#optinNational').is(':checked')) {
    survey_ids.push("1604");
  }
  if ($('#optinInternational').hasClass('checked')) {
    survey_ids.push("1625");
  }
  if ($('#optinChapter').is(':checked')) {
    $(chaptersjson['allChapters']['chapter']).each(function (index, arr) {
      if (arr['office_id'] == $('#chapter_id').val()) {
        survey_ids.push(arr['surveyID']);
      }
    });
  }

  if (survey_ids.length > 0) {
    for (var i = 0; i < survey_ids.length; i++) {
      console.log(i + ", " + survey_ids.length);

      if ((navigator.userAgent.match(/MSIE 9/i))) {
        console.log("ie9");
        xmlHttp.abort();
      }

      if (i + 1 == survey_ids.length) {
        data = "method=submitSurvey&cons_email=" + encodeURIComponent($("#eAdd").val()) + "&cons_email_opt_in=true&survey_id=" + survey_ids[i];
        luminateExtend.api.request({
          api: 'survey',
          data: data,
          callback: addCentersCallbackLast,
          requiresAuth: true,
          requestType: 'POST',
          useHTTPS: true
        });
      } else {
        data = "method=submitSurvey&cons_email=" + encodeURIComponent($("#eAdd").val()) + "&cons_email_opt_in=true&survey_id=" + survey_ids[i];
        luminateExtend.api.request({
          api: 'survey',
          data: data,
          callback: addCentersCallback,
          requiresAuth: true,
          requestType: 'POST',
          useHTTPS: true
        });
      }
    }
  } else {
    lastStep();
  }
}

jQuery(document).ready(function ($) {
  $("a.action-btn, a.btn-modal").click(function (e) {
    e.preventDefault();
  });

  // Standard donation submit button
  $("a.button-submit:eq(0)").click(function (e) {
    e.preventDefault();
    $(this).css("cursor", "not-allowed").addClass("disabled").attr("disabled", true).click(function (e) {
      e.preventDefault();
    });

    getDonationInfo();

    luminateExtend.api.request({
      api: 'donation',
      form: '#mainform',
      data: data,
      requestType: 'POST',
      callback: function (data) {
        console.log(data);
        if (data['donationResponse']['donation']) {
          finishGift();
        }
        if (data['donationResponse']['errors']) {
          var fieldError = "";
          if (data['donationResponse']['errors']['fieldError']) {
            if ($.isArray(data['donationResponse']['errors']['fieldError'])) {
              $(data['donationResponse']['errors']['fieldError']).each(function (index, arr) {
                fieldError = fieldError + arr + " ";
              });
            } else {
              fieldError = data['donationResponse']['errors']['fieldError'];
            }
          }
          showError(data['donationResponse']['errors']['pageError'], fieldError);
        }
      }
    });
  });

  // PayPal button
  $("a.button-submit:eq(1)").click(function (e) {
    e.preventDefault();
    $(this).css("cursor", "not-allowed").addClass("disabled").attr("disabled", true).click(function (e) {
      e.preventDefault();
    });

    var paypalData = data.replace('donate','startDonation') + '&extproc=paypal&finish_success_redirect=[[T1:https://secure2.convio.net/wish/site/SPageServer?pagename=donate_thankyou]]&finish_error_redirect=[[T1:https://secure2.convio.net/wish/site/SPageServer?pagename=donate_paypal_error]]';

    getDonationInfo();

    luminateExtend.api.request({
      api: 'donation',
      form: '#mainform',
      data: paypalData,
      requestType: 'POST',
      callback: function (data) {
        console.log(data);
        if (data['donationResponse']['redirect']) {
          window.isPaypal = true;
          window.paypalRedirectUrl = data['donationResponse']['redirect']['url'];
          finishGift();
        }
        if (data['donationResponse']['errors']) {
          var fieldError = "";
          if (data['donationResponse']['errors']['fieldError']) {
            if ($.isArray(data['donationResponse']['errors']['fieldError'])) {
              $(data['donationResponse']['errors']['fieldError']).each(function (index, arr) {
                fieldError = fieldError + arr + " ";
              });
            } else {
              fieldError = data['donationResponse']['errors']['fieldError'];
            }
          }
          showError(data['donationResponse']['errors']['pageError'], fieldError);
        }
      }
    });
  });
});
</script>