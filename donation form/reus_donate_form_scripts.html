<!-- Copied from v41 -->

<!-- All except productURL1 and productURL1Name were removed. - BDC 12/2/2013 -->
[[U0:productURL1=""]]
[[U0:productURL1Name=""]]

<style>.chapter-list-btn, .country-list-btn {color:gray !important;}</style>

<script src="../assets/js/jquery.zoom-min.js"></script>
<script src="../assets/js/jquery.jswipe.js" type="text/javascript"></script>
<script src="../assets/js/jquery.infinite-carousel.js" type="text/javascript"></script>

<script>

// Editable metadata fields - BDC 12/11/2013

[[S51:reus_donate_form_metadata]]

// Putting all the ZIP Codes into a variable for fast access - BDC 12/10/2013

var zip_array; $.getJSON('../assets/js/zip-codes.json', function (data) {zip_array = data});

// AJAX call to grab XML that associates centers to form IDs -- MRD 12/6/2013

center_forms = (function () {
  var xml = null;
  $.ajax({
    'async': false,
    'global': false,
    'url': 'https://secure2.convio.net/wish/assets/xml/center_info.xml',
    'dataType': "xml",
    'success': function (data) {
      xml = data;
    }
  });

  console.log(xml);

  return xml;
})();


$.fn.infiniteCarousel = function () { // this is the card selection carousel

  function repeat(str, num) {
    return new Array(num + 1).join(str);
  }

  return this.each(function () {
    var $wrapper = $('> div', this).css('overflow', 'hidden'),
      $slider = $wrapper.find('> ul'),
      $items = $slider.find('> li'),
      $single = $items.filter(':first'),

      singleWidth = 250 //$single.outerWidth(), 
      visible = Math.ceil($wrapper.innerWidth() / singleWidth),
      currentPage = 1,
      pages = Math.ceil($items.length / visible);

    // 1. Pad so that 'visible' number will always be seen, otherwise create empty items
    if (visible === 0) {
      visible = 1;
    }

    if (($items.length < 3) != 0) {
      $slider.append(repeat('<li class="empty" />', visible - ($items.length % visible)));
      $items = $slider.find('> li');
    }

    // 2. Top and tail the list with 'visible' number of items, top has the last section, and tail has the first
    $items.filter(':first').before($items.slice(-visible).clone().addClass('cloned'));
    $items.filter(':last').after($items.slice(0, visible).clone().addClass('cloned'));
    $items = $slider.find('> li'); // reselect

    // 3. Set the left position to the first 'real' item
    $wrapper.scrollLeft(singleWidth * visible);

    // 4. paging function
    function gotoPage(page) {
      var dir = page < currentPage ? -1 : 1,
        n = Math.abs(currentPage - page),
        left = singleWidth * dir * visible * n;

      $wrapper.filter(':not(:animated)').animate({
        scrollLeft: '+=' + left
      }, 500, function () {
        if (page == 0) {
          $wrapper.scrollLeft(singleWidth * visible * pages);
          page = pages;
        } else if (page > pages) {
          $wrapper.scrollLeft(singleWidth * visible);
          // reset back to start position
          page = 1;
        }

        currentPage = page;
      });

      return false;
    }

    $wrapper.after('<a class="arrow back"></a><a class="arrow forward"></a>');

    // 5. Bind to the forward and back buttons
    $('a.back', this).click(function () {
      return gotoPage(currentPage - 1);
    });

    $('a.forward', this).click(function () {
      return gotoPage(currentPage + 1);
    });

    // create a public interface to move to a specific page
    $(this).bind('goto', function (event, page) {
      gotoPage(page);
    });
  });
};

$(document).ready(function () {

  // BDC

  $('#saveAdd').hide();

  // BDC

  $.jStorage.deleteKey("hideGiftType");

  var donationID = $('.js_donationConfigurator').attr('data-donation-id'), //random number
  cardsList = [], // empty array
  giftTypeButtons = $("#giftTypes").html(), // single and monthly buttons
  initProducts = $("ul#products").html(); // greyed out preview cards

  $("#saveAdd, .add-button").live('click', function () { // add donation buttons
    donationID = $('.js_donationConfigurator').attr('data-donation-id'); // dup
    // grey out donation button that's not clicked
    if ($("a#monthlyGift").hasClass("selected")) {
      $("a#monthlyGift").removeClass('disabled').addClass('selected').removeAttr("disabled").css("cursor", "pointer");
      $("a#monthlyGift").trigger("click");
      $("a#singleGift").addClass('disabled').attr('disabled', true).unbind('click').removeClass("selected").css("cursor", "not-allowed");
      $("a#singleGift").click(function (e) {
        e.preventDefault();
      });

    }
    // grey out donation button that's not clicked
    if ($("a#singleGift").hasClass("selected")) {

      $("a#monthlyGift").addClass('disabled').attr('disabled', true).unbind('click').css("cursor", "not-allowed");
      $("a#monthlyGift").click(function (e) {
        e.preventDefault();
      });

    }
  });

  $('.infiniteCarousel').infiniteCarousel(); // init infiniteCarousel
  $('select.event-select').customSelectMenu(); // select occasion
  $('select.type-select').customSelectMenu(); // select card type
  $('.option-one li:first').remove(); // remove list item
  $('.option-two li:first').remove(); // remove list item
  if ($("select.event-select option").val() == '') { // if no occasion chosen, disable everything
    $('.select-area-2').addClass('disabled');
    $('.select-area-3').addClass("disabled");
    $('#carousel-gallery').addClass("disabled");
    $('.option-two ul').css({
      opacity: 0
    });
  }

  var showStep1 = function () {
    $('.top-actions .back-btn').hide();
    $('.top-actions .help-btn, .top-actions .cancel-btn').show();
    $('#lightbox-main h1').text('Select a certificate, card, or e-card');
    $('#step1').show();
    $('#step2').hide();
    $('#step3').hide();
  }

  var showStep2 = function () {
    $('.top-actions .back-btn').show();
    $('.top-actions .help-btn, .top-actions .cancel-btn').hide();
    $('#lightbox-main h1').text('Select a certificate, card, or e-card');
    $('#step1').hide();
    $('#step2').show();
    $('#step3').hide();
  }

  function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
      vars[key] = value;
    });
    return vars;
  }

  var urlVariableArray = getUrlVars();

  $(window).load(function () {
    for (var index in urlVariableArray) {
      if (index == "card_type") {
        launchCard(urlVariableArray[index]);
      }
    }
  });

  var productsjson = (function () {
    var json = null;
    $.ajax({
      'async': false,
      'global': false,
      'url': 'https://secure2.convio.net/wish/assets/js/products.json',
      'dataType': "json",
      'success': function (data) {
        json = data;
      }
    });
    return json;
  })();

  var checkFields = function () {
    var boolean = true;
    console.log("state: " + $("#State_X option:selected").val());
    $('#step3 .jsreq:visible').each(function () {
      if ($(this).val() == '') {
        $(this).addClass('input-error');
        $(this).next("p").show();
        $(this).prev("label").addClass("label-error");
        $(".bldr-wrap #card-form .mnamefld").prev("fieldset").css({
          "position": "relative"
        });
        $(".bldr-wrap #card-form .mnamefld").css({
          "left": "300px",
          "margin-left": "12px",
          "position": "absolute",
          "top": "12px"
        });
        boolean = false;

        if ($("#State_X").hasClass("input-error")) {
          $("#uniform-State_X span").addClass("input-error");
          $("#uniform-State_X").next("p").show();
          $("#uniform-State_X").prev("label").addClass("label-error");
        }
      } else {
        $(this).removeClass('input-error');
      }
    });
    return boolean;
  }

  // Get available occasions and add to first drop down list
  var occasionTypes = [];

  $(productsjson['product']).each(function (index, arr) {
    if ($.inArray(arr['occasion_type'], occasionTypes) == -1) {
      occasionTypes.push(arr['occasion_type']);
    }
  });
  for (var i in occasionTypes) {
    $('.event-select').append('<option value="' + occasionTypes[i] + '">' + occasionTypes[i] + '</option>')
    $('#selectOccasion ul').append('<li data-option-value="' + occasionTypes[i] + '">' + occasionTypes[i] + '</li>')
  }

  function launchCard(id) {
    console.log("Card ID: " + id);

    $.fancybox({
      href: '#js-prod-personalizer',
      autoSize: false,
      width: '1018px',
      height: '585px',
      padding: 0,
      scrolling: 'no',
      modal: true,
      closeBtn: false,
      margin: [5, 5, 5, 5],
      afterShow: function () {
        mawf.$personalizer.find('select').trigger('change'); // Uniform needs help with session restore update of hidden selects
        $.fancybox.update(); // Ensure fancybox resizes to be scrollable with lower resolutions  
      },
      afterClose: function () {
        mawf.shutDownProductModal();
      }
    });

    selectCard(id);
  }

  // When an occasion is selected, load available card types for it in the second drop down list

  $(".option-one").on('click', 'li', function (e) {
    e.preventDefault();
    var thisEcardProduct = [];
    var thisCertificateProduct = [];
    var thisCardProduct = [];
    $('#finishCertificate, #finishCard, #finisheCard').unbind("click");

    if (!$("#carousel-gallery").hasClass("disabled")) {
      $("ul#products").remove();
      $("a.arrow").remove();
      $("h4#cardCount").text("");
    }

    var thisOccasion = $(this).text();
    var availableTypes = [];

    $(productsjson['product']).each(function (index, arr) {
      if (arr['occasion_type'] == thisOccasion && $.inArray(arr['card_type'], availableTypes) == -1) {
        availableTypes.push(arr['card_type']);
      }
    });
    var optionHTML = "";
    var listHTML = "";
    var certificateMsg = "Create a printable certificate.";
    var cardMsg = "We\'ll mail a card on your behalf.";
    var ecardMsg = "Send an e-card.";

    for (i in availableTypes) {
      optionHTML += '<option value="' + availableTypes[i] + '">' + availableTypes[i] + '</option>';
      listHTML += '<li data-option-value="' + availableTypes[i] + '">' + availableTypes[i] + '<br /><span>';
      if (availableTypes[i] == "Certificate") {
        listHTML += certificateMsg;
      }
      if (availableTypes[i] == "Card") {
        listHTML += cardMsg;
      }
      if (availableTypes[i] == "E-Card") {
        listHTML += ecardMsg;
      }
      listHTML += '</span></li>';
    }

    $('.type-select').html(optionHTML);
    $('#selectCardType ul').html(listHTML);

    $('#selectCardType label').text('Select Card Type');
    $('div.select-area-2').removeClass("disabled");
    $('.option-two ul').css({
      opacity: 1
    });
  });

  /////////////////////////////////////////////////////////////////////////////////////////////

  // When a card type is selected, load the ecards into the carousel

  function optionTwo(thisCardType) {

    var occasionType = $('#selectOccasion input[type=hidden]').val();
    
    var products = [];
    var cardCount = 0;

    $(productsjson['product']).each(function (index, arr) {
      if (arr['card_type'] == thisCardType && arr['occasion_type'] == occasionType) {
        if (arr['is_new'].toLowerCase() == "true") {
          products.push('<li><div class="hover-bar"><a class="magnify" href="#" data-cardID="' + arr['card_id'] + '"></a><a class="select-card" href="#" data-cardID="' + arr['card_id'] + '"></a></div><img src="' + arr['card_image1'] + '" class="new-item"></li>');
        } else {
          products.push('<li><div class="hover-bar"><a class="magnify" href="#" data-cardID="' + arr['card_id'] + '"></a><a class="select-card" href="#" data-cardID="' + arr['card_id'] + '"></a></div><img src="' + arr['card_image1'] + '"></li>');
        }
        cardCount++
      }
    });

    $("ul#products").remove();
    $("a.arrow").remove();
    if (cardCount > 3) {
      $('#carousel-gallery .wrapper').append('<ul id="products">' + products + products + '</ul>');
    } else {
      $('#carousel-gallery .wrapper').append('<ul id="products">' + products + '</ul>');
    }
    $('.infiniteCarousel').infiniteCarousel();

    if (cardCount < 3) {
      $("a.arrow").unbind("click").css({
        'opacity': '.2',
        'cursor': 'none'
      });
      $("a.arrow").click(function (e) {
        e.preventDefault();
      });
    }

    addNewTag();

    if (cardCount == 1) {
      $('#cardCount').text(cardCount + '  Card');
    } else {
      $('#cardCount').text(cardCount + '  Cards');

    }

    $('div.select-area-3').removeClass("disabled");
    $('div#carousel-gallery').removeClass("disabled");

  }

  $(".option-two").on('click', 'li', function (e) {
    e.preventDefault();

    var cardType = $('#selectCardType input[type=hidden]').val();
    optionTwo(cardType);

  });

  $(".option-two li>span").live("click", function () {
    console.log("click: " + $(this).parent().attr("data-option-value"));
    var cardType = $(this).parent().attr("data-option-value");
    optionTwo(cardType);
  });

  var addNewTag = function () {
    $('li img.new-item').after('<span><img src="http://site.wish.org/assets/images/new-tag.png" /></span>');
    $('ul#products > li').hover(function () {
      $(this).after('');
    });
  }
  /////////////////////////////////////////////////////////////////////////////////////////////

  $('.wrapper').on('click', 'a.magnify', function (e) {
    if (!$(this).parents().hasClass('disabled')) {
      e.preventDefault();

      var card_id = $(this).attr('data-cardid');

      if (card_id.substring(0, 2) == 'EC') {
        selectEcard(card_id);
      } else {
        selectCard(card_id);
      }

    }
  });

  $('.wrapper').on('click', 'a.select-card', function (e) {
    if (!$(this).parents().hasClass('disabled')) {
      e.preventDefault();

      var card_id = $(this).attr('data-cardid');

      customizeCard(card_id);

    }
  });

  var ecard_id = "";
  var card_name = "";
  var card_type = "";
  var occasion_type = "";
  var card_image1 = "";
  var card_image2 = "";
  var card_image3 = "";
  var card_image4 = "";
  var card_image5 = "";
  var card_thumbnail = "";
  var product_url = "";
  var skew = "";

  // When a card is selected, load the description page

  function selectEcard(cardID) {
    $(productsjson['product']).each(function (index, arr) {
      if (arr['card_id'] == cardID) {
        ecard_id = arr['ecard_id'] || false;
        product_url = arr['product_url'] || false;
        return false;
      }
    });
    window.open(product_url, "ecard");
  }

  function selectCard(cardID) {

    $(productsjson['product']).each(function (index, arr) {
      if (arr['card_id'] == cardID) {
        ecard_id = arr['ecard_id'] || false;
        card_name = arr['card_name'];
        card_type = arr['card_type'];
        occasion_type = arr['occasion_type'];
        card_image1 = arr['card_image1'];
        card_image2 = arr['card_image2'] || false;
        card_image3 = arr['card_image3'] || false;
        card_image4 = arr['card_image4'] || false;
        card_image5 = arr['card_image5'] || false;
        card_thumbnail = arr['card_thumbnail'] || "https://secure2.convio.net/wish/Card images/General/Certficates/blank.png";
        product_url = arr['product_url'] || false;
        return false;
      }
    });

    $('.productImageContainer').html('<span class="zoom" id="productImageContainer"><img src="' + card_image2 + '" height="410" width="410"></span>');

    $('#productImageContainer').zoom();

    $('.productImageContainer img').each(function () {
      var productHeight = $(this).height();
      var productWidth = $(this).width();

      if (productHeight == productWidth) {
        $(this).addClass('square');
      } else if (productHeight > productWidth) {
        $(this).addClass('portrait');
      } else {
        $(this).addClass('landscape');
      }
    });

    $('.cardDescription').load('https://secure2.convio.net/wish/site/SPageNavigator/reus_card_' + cardID + '.html #container');
    if (card_type = "card") {
      var cardThumbs = '<img src="' + card_image2 + '" width="40" height="40" class="card-thumb" />';

      if (card_image3 != "") {
        cardThumbs = cardThumbs + '<img src="' + card_image3 + '" width="40" height="40" class="card-thumb" />';
      }
      if (card_image4 != "") {
        cardThumbs = cardThumbs + '<img src="' + card_image4 + '" width="40" height="40" class="card-thumb" />';
      }
      if (card_image5 != "") {
        cardThumbs = cardThumbs + '<img src="' + card_image5 + '" width="40" height="40" class="card-thumb" />';
      }
      $(".card-thumbs").html(cardThumbs);
    }

    $("img.card-thumb").click(function (e) {
      e.preventDefault();
      var whichThumb = $(this).attr("src");
      $('.productImageContainer').html('<span class="zoom" id="productImageContainer"><img src="' + whichThumb + '" height="410" width="410" /></span>');
      $('#productImageContainer').zoom();
    });

    showStep2();

    $('.lightbox-rightside').on('click', 'a.cont-btn', function (e) {
      if (!$(this).parents().hasClass('disabled')) {
        e.preventDefault();
        customizeCard(cardID);
      }
    });
    return;
  }

  function customizeCard(cardID) {

    $(productsjson['product']).each(function (index, arr) {
      if (arr['card_id'] == cardID) {
        ecard_id = arr['ecard_id'] || false;
        card_name = arr['card_name'];
        card_type = arr['card_type'];
        occasion_type = arr['occasion_type'];
        card_image1 = arr['card_image1'];
        card_image2 = arr['card_image2'] || false;
        card_image3 = arr['card_image3'] || false;
        card_image4 = arr['card_image4'] || false;
        card_image5 = arr['card_image5'] || false;
        card_thumbnail = arr['card_thumbnail'] || "https://secure2.convio.net/wish/Card images/General/Certficates/blank.png";
        product_url = arr['product_url'] || false;
        skew = cardID;

        // Setting Skew information to hidden input field for Satellite Data - MRD 12/12/13
        $("input[name='s_sat_skew']").val(skew);

        return false;
      }
    });

    showStep3(ecard_id, card_name, card_type, occasion_type, card_image1, card_image2, card_image3, card_thumbnail, product_url, skew);

    return;

  }

  //Cancel button clears selections
  $('.cancel-btn').click(function () {
    $.fancybox.close();
    resetProducts();
    // Setting Skew information to hidden input field for Satellite Data - MRD 12/13/13
    $("input[name='s_sat_skew']").val('');
  });

  //Reset Products
  function resetProducts() {
    $('#step3 .jsreq').each(function () {
      $(this).removeClass('input-error');
      $(this).next("p").hide();
      $(this).prev("label").removeClass("label-error");
    });

    $("#uniform-State_X span").removeClass("input-error");
    $("#uniform-State_X").next("p").hide();
    $("#uniform-State_X").prev("label").removeClass("label-error");
    $(".bldr-wrap #card-form .mnamefld").css({
      "left": "0px",
      "margin-left": "12px",
      "position": "relative",
      "top": "0px"
    });

    $(".option-one li.selected").removeClass("selected");
    $(".option-two li.selected").removeClass("selected");
    $(".option-one label").removeClass("selection-made").text("Select Occasion");
    $(".option-two label").removeClass("selection-made").text("Select Card Type");
    $(".option-one input").attr("value", "Select Occasion");
    $(".option-two input").attr("value", "Select Card Type");
    $('#cardCount').text("");
    $('.select-area-2').addClass('disabled');
    $('.select-area-3').addClass("disabled");
    $('#carousel-gallery').addClass("disabled");
    $('.option-two ul').css({
      opacity: 0
    });
    $('#carousel-gallery .wrapper').html('<ul id="products">' + initProducts + "</ul>");
    products = "";
    $("#step3 input").val("");
    $("#step3 textarea").val("");
    $("#State_X option:first").attr("selected", "selected");
    $('#step1').show();
    $('#step2').hide();
    $('#step3').hide();

    toFirstName = "";
    toMI = "";
    toLastName = "";
    toInHonorOf = "";
    toEmail = "";
    toFullName = "";
    fromName = "";
    toAddress1 = "";
    toAddress2 = "";
    toCity = "";
    toState = "";
    toZip = "";
    toCountry = "";
    message = "";
    ecardID = "";
    cardName = "";
    cardType = "";
    occasionType = "";
    cardImage1 = "";
    cardImage2 = "";
    cardImage3 = "";
    cardThumbnail = "";
    productURL = "";
    skew = "";
  }

  // If the "Back to Selection" button is clicked, go to step 1
  $('.top-actions .back-btn').click(function (e) {
    e.preventDefault();
    showStep1();
  });

  var showStep3 = function (ecardID, cardName, cardType, occasionType, cardImage1, cardImage2, cardImage3, cardThumbnail, productURL, thisSkew) {
    $('#step1, #step2, .top-actions .help-btn, .top-actions .back-btn').hide();
    $('#step3, .top-actions .cancel-btn').show();
    $('#step3 #productTitle').text(cardName);
    $('.cardThumbnail').attr('src', cardThumbnail);

    var toFirstName = "";
    var toMI = "";
    var toLastName = "";
    var toInHonorOf = "";
    var toEmail = "";
    var toFullName = "";
    var fromName = "";
    var toAddress1 = "";
    var toAddress2 = "";
    var toCity = "";
    var toState = "";
    var toZip = "";
    var toCountry = "";
    var message = "";

    // Show the correct fields based on card type
    if (cardType == "E-Card") {
      
    // Add occasion type to hidden input field for Satellite Data
    $("input[name='s_sat_ecard_occasion_type']").val(occasionType);
    
      $('#js-prod-personalizer h1').text('Customize E-Card');

      $('fieldset.memorial .inMemoryOf, fieldset.memorial .ifEmptyDefault, fieldset.memorial .ifEmptyCard, fieldset.sendTo .defaultTo, fieldset.sendTo .defaultName, fieldset.sendTo .js_mname, fieldset.sendTo .weddingName, fieldset.sendTo .physical, fieldset.memorialHonorOf, fieldset.fromInfo .infoForCert, fieldset.fromInfo .infoForCard, fieldset.messageInfo .cardMessage, .bottomButtons .leaveBlank, #finishCard, #finishCertificate').hide();

      $('fieldset.memorial, fieldset.memorial .inHonorOf, fieldset.memorial .ifEmptyEcard, fieldset.sendTo, fieldset.sendTo .sendTo,  fieldset.sendTo .digital, fieldset.messageInfo, fieldset.messageInfo .ecardMessage, #finisheCard').show();

      $('#finisheCard').click(function (e) {
        e.preventDefault();
        var numCard = cardsList.length;
        console.log("numCard=" + numCard);
        if (checkFields()) {
          toFirstName = encodeURIComponent($("input[name='MemorialFirst_X_v2']").val());
          toMI = encodeURIComponent($("input[name='MemorialMI_X']").val()) || false;
          toLastName = encodeURIComponent($("input[name='MemorialLast_X']").val());
          toInHonorOf = encodeURIComponent($("input[name='MemorialName_X']").val()) || false;
          toEmail = encodeURIComponent($("input[name='MHEMail_X']").val());
          toFullName = "";
          fromName = encodeURIComponent($("input[name='LastName_X']").val());
          message = encodeURIComponent($("textarea[name='Comments_X']").val());

          // If the "In honor of" field is blank, create full name from First, Middle, Last
          if (!toInHonorOf) {
            if (toMI) {
              toFullName = toFirstName + "%20" + toMI + "%20" + toLastName;
            } else {
              toFullName = toFirstName + "%20" + toLastName
            }
          } else {
            toFullName = toInHonorOf
          }

          // Add the card info to the card list to process later
          thisEcardProduct = [donationID, 'ecard', toFullName, toEmail, fromName, cardName, message, ecardID, productURL, cardName, occasionType, thisSkew];
          cardsList[numCard] = thisEcardProduct;

          console.log("push ecard: " + cardsList[numCard][7]);
          $.fancybox.close();
          resetProducts();
          return;
        }
      }); //click

    } else if (cardType == "Certificate") {
      
      // Add occasion type to hidden input field for Satellite Data
      $("input[name='s_sat_ecert_occasion_type']").val(occasionType);
      
      $('#js-prod-personalizer h1').text('Customize Certificate');

      $('fieldset.memorial .inMemoryOf, fieldset.memorial .ifEmptyEcard, fieldset.memorial .ifEmptyCard, fieldset.sendTo, fieldset.memorialHonorOf, fieldset.fromInfo .infoForCard, fieldset.messageInfo, .bottomButtons .leaveBlank, #finisheCard, #finishCard').hide();

      $('fieldset.memorial, fieldset.memorial .inHonorOf, fieldset.memorial .ifEmptyDefault, fieldset.fromInfo .infoForCert, #finishCertificate').show();

      $('#finishCertificate').click(function (e) {
        e.preventDefault();
        var numCard = cardsList.length;
        console.log("numCard=" + numCard);

        if (checkFields()) {
          toFirstName = $("input[name='MemorialFirst_X_v2']").val();
          toMI = $("input[name='MemorialMI_X']").val() || false;
          toLastName = $("input[name='MemorialLast_X']").val();
          toInHonorOf = $("input[name='MemorialName_X']").val() || false;
          toFullName = "";
          fromName = $("input[name='LastName_X']").val();

          // If the "In honor of" field is blank, create full name from First, Middle, Last
          if (!toInHonorOf) {
            if (toMI) {
              toFullName = toFirstName + " " + toMI + " " + toLastName;
            } else {
              toFullName = toFirstName + " " + toLastName
            }
          } else {
            toFullName = toInHonorOf
          }

          // Add the card info to the card list to process later
          thisCertificateProduct = [donationID, 'certificate', toFullName, fromName, productURL, cardName, occasionType, thisSkew];
          cardsList[numCard] = thisCertificateProduct;

          console.log("push certificate: " + cardsList[numCard][4]);
          $.fancybox.close();
          resetProducts();
          return;
        }

        return;
      }); //click

    } else if (cardType == "Card") {
      
      // Add occasion type to hidden input field for Satellite Data
      $("input[name='s_sat_card_occasion_type']").val(occasionType);

      $('#js-prod-personalizer h1').text('Customize Card');

      $('fieldset.memorial, fieldset.sendTo .defaultTo, fieldset.sendTo .weddingName, fieldset.sendTo .js_mname, fieldset.sendTo .digital, fieldset.memorialHonorOf, fieldset.fromInfo .infoForCert, fieldset.messageInfo .ecardMessage, #finisheCard, #finishCertificate ').hide();

      $('fieldset.sendTo, fieldset.sendTo .sendTo, fieldset.sendTo .defaultName, fieldset.sendTo .physical, fieldset.fromInfo, fieldset.fromInfo .infoForCard, .bottomButtons .leaveBlank, fieldset.messageInfo, fieldset.messageInfo .cardMessage, #finishCard').show();

      $('.leaveBlank').click(function (e) {
        e.preventDefault();
        var numCard = cardsList.length;
        console.log("numCard=" + numCard);

        // Add the card info to the card list to process later
        thisCardProduct = [donationID, 'card-blank', cardName, occasionType, thisSkew];
        cardsList[numCard] = thisCardProduct;
        console.log("push card: " + cardsList[numCard][2]);
        $.fancybox.close();
        resetProducts();
        return;

      }); //click

      $('#finishCard').click(function (e) {
        e.preventDefault();
        var numCard = cardsList.length;
        console.log("numCard=" + numCard);

        if (checkFields()) {
          toFirstName = $("input[name='MHFirst_X']").val();
          toMI = $("input[name='MHMI_X']").val() || false;
          toLastName = $("input[name='MHLast_X']").val();
          toFullName = "";
          toAddress1 = $("input[name='Address1_X']").val();
          toAddress2 = $("input[name='Address2_X']").val();
          toCity = $("input[name='City_X']").val();
          toState = $("select#State_X option:selected").val();
          toZip = $("input[name='PostalCode_X']").val();
          toCountry = $("select#Country_X option:selected").val();
          fromName = $("input[name='LastName_X']").val();
          message = $("input[name='Custom10_X']").val() + " " + $("input[name='Custom11_X']").val() + " " + $("input[name='Custom12_X']").val();
          var msgLine1 = $("input[name='Custom10_X']").val();
          var msgLine2 = $("input[name='Custom11_X']").val();
          var msgLine3 = $("input[name='Custom12_X']").val();

          // Create full name from First, Middle, Last
          if (toMI) {
            toFullName = toFirstName + " " + toMI + " " + toLastName;
          } else {
            toFullName = toFirstName + " " + toLastName;
          }

          // Add the card info to the card list to process later
          thisCardProduct = [donationID, 'card', toFullName, toAddress1, toAddress2, toCity, toState, toZip, toCountry, fromName, productURL, message, cardName, msgLine1, msgLine2, msgLine3, occasionType, thisSkew];
          cardsList[numCard] = thisCardProduct;

          console.log("push card: " + cardsList[numCard][10]);
          $.fancybox.close();
          resetProducts();
          return;
        }
      }); //click
    }

    return;
  }

  // If the "Back to Selection" button is clicked, go to step 1
  $('.middle-actions .back-btn').click(function (e) {
    e.preventDefault();
    showStep1();
  });

  // Function returns string encrypted
  function escapeAll(e) {
    var t = "";
    for (var n in e) {
      n = e.charAt(n);
      for (i = 0; i <= 256; ++i) {
        var r = i.toString(16);
        if (r.length == 1) r = "0" + r;
        r = "%" + r;
        if (unescape(r) == n) {
          t += r;
          break
        } else if (i == 256) {
          t += escape(n);
          break
        }
      }
    }
    return t
  }

  getDonationInfo = function () {
    var donations = mawf.CartView.donations();
    console.log("Donations: " + donations.toString());
    var monthly = false;
    var totalGift = 0.00;
    var x = 1;

    var bitlyURL = "";

    function get_short_url(long_url) {
      var returnURL = "";

      $.ajax({
        async: false, //thats the trick
        url: 'https://api-ssl.bitly.com/v3/shorten?format=json',
        dataType: 'json',
        data: {
          "format": "json",
          "apiKey": "R_50a44d5e5edc4dacaccb0841183fd8ce",
          "login": "wishamerica",
          "longUrl": long_url
        },
        success: function (response) {
          returnURL = response['data']['url'];
          console.log(returnURL);
        }
      });

      return returnURL;
    }

    for (var i in donations) {
      var cid = donations[i].donorIntent();
      var designation = "";
      var amnt = parseFloat(donations[i].prettyDonationAmount());
      var type = donations[i].donationType();
      var designee = "";
      var officeID;

      if($("input[name='s_sat_skew']").val() === '') {
        if(type === 1){
          $("input[name='s_sat_skew']").val('DO02-01');
        } else if(type === 2) {
          $("input[name='s_sat_skew']").val('MG05-01');
        } else {
          console.log('error: s_sat_skew is blank but was not set');
        }
      } else {
        console.log('s_sat_skew should be an hon/mem id');
      } 

      if (cid === "100-000") {
        designation = "1066";
        designee = "Make-A-Wish® America";
        officeID = "100-000";
      } else if (cid === "500-000") {
        designation = "1067";
        designee = "Make-A-Wish® International"
        officeID = "500-000";
      } else {
        $(chaptersjson['allChapters']['chapter']).each(function (index, arr) {
          if (arr['office_id'] == cid) {
            designation = arr['designation_id'];
            designee = arr['office_name'];
            officeID = arr['office_id'];
          }
        });
      }

      // BDC 12/10/2013
      // --------------

      var short_cid = cid.substr(0,3),
        form_cid = $('.logo a').attr('href').match(/\d+/)[0],
        donation_form_id = $(center_forms).find('office#' + short_cid + ' + form').attr('id'),
        isMonthly = false;

      data = data.replace(/form_id=\d{4}/,'form_id=' + donation_form_id);
      data += '&s_cid=' + cid;

      if($('#monthlyGift.selected').length > 0) {
        isMonthly = true;
      }

      if( form_cid === '100' ) {
        if( short_cid === '100' ) {
          // National form, national donation
          if($('#foreign_key1').val() === '') $('#foreign_key1').val(metadata_campaign_id);
          if($('#foreign_key2').val() === '') $('#foreign_key2').val('UR-' + short_cid + '-01');
          if($('#foreign_key3').val() === '') $('#foreign_key3').val(metadata_appeal_year + '-NSP-' + (isMonthly ? metadata_national_monthly : metadata_national_office_code) );
          if($('#foreign_key4').val() === '') $('#foreign_key4').val('ON-' + metadata_national_office_code + '-' + form_cid);
          if($('#foreign_key5').val() === '') $('#foreign_key5').val(metadata_subtype);
        }
        else {
          // National form, chapter donation
          if($('#foreign_key1').val() === '') $('#foreign_key1').val(metadata_campaign_id);
          if($('#foreign_key2').val() === '') $('#foreign_key2').val('UR-' + short_cid + '-01');
          if($('#foreign_key3').val() === '') $('#foreign_key3').val(metadata_appeal_year + '-82S-' + (isMonthly ? metadata_national_monthly : metadata_national_office_code) );
          if($('#foreign_key4').val() === '') $('#foreign_key4').val('ON-' + metadata_national_office_code + '-' + form_cid);
          if($('#foreign_key5').val() === '') $('#foreign_key5').val(metadata_subtype);
        }
      }
      else {
        if( form_cid === short_cid ) {
          // Chapter form, same chapter
          if($('#foreign_key1').val() === '') $('#foreign_key1').val(metadata_campaign_id);
          if($('#foreign_key2').val() === '') $('#foreign_key2').val('UR-' + short_cid + '-01');
          if($('#foreign_key3').val() === '') $('#foreign_key3').val(metadata_appeal_year + '-NSP-' + (isMonthly ? metadata_chapter_monthly : metadata_chapter_office_code) );
          if($('#foreign_key4').val() === '') $('#foreign_key4').val('ON-' + metadata_chapter_office_code + '-' + form_cid);
          if($('#foreign_key5').val() === '') $('#foreign_key5').val(metadata_subtype);
        }
        else {
          // Chapter form, different chapter
          if($('#foreign_key1').val() === '') $('#foreign_key1').val(metadata_campaign_id);
          if($('#foreign_key2').val() === '') $('#foreign_key2').val('UR-' + short_cid + '-01');
          if($('#foreign_key3').val() === '') $('#foreign_key3').val(metadata_appeal_year +'-82S-' + (isMonthly ? metadata_chapter_monthly : metadata_chapter_office_code) );
          if($('#foreign_key4').val() === '') $('#foreign_key4').val('ON-'+ metadata_chapter_office_code + '-' + form_cid);
          if($('#foreign_key5').val() === '') $('#foreign_key5').val(metadata_subtype);
        }
      }

      $('#source').val($('#foreign_key2').val() + ',' + $('#foreign_key3').val() + ',' + $('#foreign_key4').val())

      // --------------
      // BDC 12/10/2013

      // If donation type is 2, this is a monthly gift
      if (type == 2) {
        monthly = true;
      }

      // Add this donation amount to the total
      totalGift += amnt;

      // Add designation info to data
      data = data + "&designated." + x + ".amount=" + amnt + "&designated." + x + ".id=" + designation + "&s_designeeName" + x + "=" + encodeURIComponent(designee) + "&s_designeeAmt" + x + "=" + amnt + "&s_CID=" + cid;
      x++;

    } // for loop

    if (data.indexOf("designeeName1") == -1) {
      data = data + "&s_designeeName1=&s_designeeAmt1=";
    }
    if (data.indexOf("designeeName2") == -1) {
      data = data + "&s_designeeName2=&s_designeeAmt2=";
    }
    if (data.indexOf("designeeName3") == -1) {
      data = data + "&s_designeeName3=&s_designeeAmt3=";
    }
    if (data.indexOf("designeeName4") == -1) {
      data = data + "&s_designeeName4=&s_designeeAmt4=";
    }
    if (data.indexOf("designeeName5") == -1) {
      data = data + "&s_designeeName5=&s_designeeAmt5=";
    }

    if (monthly) {
      data = data + "&sustaining.frequency=monthly&sustaining.duration=0";
    }

    data = data + "&remember_me=true&other_amount=" + totalGift;

    if ($('#optinNational').is(':checked') || $('#optinInternational').hasClass('checked') || $('#optinChapter').is(':checked')) {
      data = data + "&donor.email_opt_in=true";
    }

    var certNum = 1;
    var today = Date.today().toString('M/dd/yyyy') || "8/20/2013";
    var e = true;

    for (var i in cardsList) {

      if (cardsList[i][1] == 'ecard') {
        var ecard_first_name = $("input[name='billing.name.first']").val()
        var ecard_last_name = $("input[name='billing.name.last']").val()
        var ecard_sender_email = $("input[name='donor.email']").val()
        var ecard_recipient_name = cardsList[i][2];
        var ecard_recipient_email = cardsList[i][3];
        var ecard_stationary_id = cardsList[i][7];
        var ecard_subject = ecard_first_name + " " + ecard_last_name + " has sent you an e-card";
        var ecard_message = cardsList[i][6];
        var honoreeProduct = cardsList[i][8];
        var occassionType = cardsList[i][10];
        var prodSkew = cardsList[i][11];

        var prodURL = 'https://secure2.convio.net/wish/site/Ecard?ecard_id=1061&ecard_form=true&cons_info_component=t&cons_first_name=' + ecard_first_name + '&cons_last_name=' + ecard_last_name + '&cons_email=' + ecard_sender_email + '&cons_mail_opt_in=t&cons_email_opt_in=on&cons_email_opt_in_requested=true&s_rememberMe=on&sendtoemail=' + ecard_recipient_email + '&stationery_layout_chooser=true&stationery_layout_id=' + ecard_stationary_id + '&subject=' + ecard_subject + '&message=' + ecard_message + '&taf_send=Send+eCard++&denySubmit=&pgwrap=n';

        //bitlyURL = get_short_url(prodURL);

        data = data + "&product_" + certNum + "_honoree_name=" + ecard_recipient_name + "&product_" + certNum + "_honoree_message=" + encodeURIComponent(ecard_message) + "&product_" + certNum + "_honoree_email=" + encodeURIComponent(ecard_recipient_email) + "&product_url_" + certNum + "=" + encodeURIComponent(honoreeProduct) + "&s_productURL" + certNum + "=" + encodeURIComponent(prodURL);
      } else if (cardsList[i][1] == 'certificate') {
        var honoreeName = cardsList[i][2];
        var productFromName = cardsList[i][3];
        var honoreeProduct = cardsList[i][4];
        var honoreeProductName = cardsList[i][5];
        var occassionType = cardsList[i][6];
        var prodSkew = cardsList[i][7];
        var prodURL = "http://site.wish.org/site/PageNavigator/products.html?key=" + today + "&pdf=" + honoreeProduct + "&HonorName=" + encodeURIComponent(honoreeName) + "&DonorName=" + encodeURIComponent(productFromName);

        bitlyURL = get_short_url(prodURL);

        data = data + "&product_" + certNum + "_honoree_name=" + honoreeName + "&product_url_" + certNum + "=" + bitlyURL + "&s_productURL" + certNum + "=" + encodeURIComponent(prodURL) + "&s_productURL" + certNum + "Name=" + encodeURIComponent(honoreeProductName);
      } else if (cardsList[i][1] == 'card') {
        var honoreeName = cardsList[i][2];
        var honoreeAdd1 = cardsList[i][3];
        var honoreeAdd2 = cardsList[i][4];
        var honoreeCity = cardsList[i][5];
        var honoreeState = cardsList[i][6];
        var honoreeZip = cardsList[i][7];
        var honoreeCountry = cardsList[i][8];
        var productFromName = cardsList[i][9];
        var honoreeProduct = cardsList[i][10];
        var honoreeMessage = cardsList[i][11];
        var honoreeProductName = cardsList[i][12];
        var prodMsgLine1 = cardsList[i][13];
        var prodMsgLine2 = cardsList[i][14];
        var prodMsgLine3 = cardsList[i][15];
        var occassionType = cardsList[i][16];
        var prodSkew = cardsList[i][17];

        var prodURL = "http://site.wish.org/site/PageNavigator/products.html?key=" + today + "&pdf=" + honoreeProduct + "&HonorName=" + encodeURIComponent(honoreeName) + "&DonorName=" + encodeURIComponent(productFromName) + "&line1=" + encodeURIComponent(prodMsgLine1) + "&line2=" + encodeURIComponent(prodMsgLine2) + "&line3=" + encodeURIComponent(prodMsgLine3);

        bitlyURL = get_short_url(prodURL);

        data = data + "&product_" + certNum + "_honoree_name=" + honoreeName + "&product_" + certNum + "_honoree_address1=" + honoreeAdd1 + "&product_" + certNum + "_honoree_address2=" + honoreeAdd2 + "&product_" + certNum + "_honoree_city=" + honoreeCity + "&product_" + certNum + "_honoree_state=" + honoreeState + "&product_" + certNum + "_honoree_zip=" + honoreeZip + "&product_" + certNum + "_honoree_country=" + honoreeCountry + "&product_url_" + certNum + "=" + bitlyURL + "&s_productURL" + certNum + "=" + encodeURIComponent(prodURL) + "&product_" + certNum + "_honoree_message=" + honoreeMessage + "&s_productURL" + certNum + "Name=" + encodeURIComponent(honoreeProductName);

      } else if (cardsList[i][1] == "card-blank") {
        var honoreeProductName = cardsList[i][2];
        var occassionType = cardsList[i][3];
        var prodSkew = cardsList[i][4];
        data = data + "&product_url_" + certNum + "=blank&s_productURL" + certNum + "=blank&s_productURL" + certNum + "Name=" + encodeURIComponent(honoreeProductName);

      }
      certNum++;
    }

    if (data.indexOf("product_url_1") == -1) {
      data = data + "&product_url_1=none&s_productURL1=none&s_productURL1Name=none";
    }
    if (data.indexOf("product_url_2") == -1) {
      data = data + "&product_url_2=none&s_productURL2=none&s_productURL2Name=none";
    }
    if (data.indexOf("product_url_3") == -1) {
      data = data + "&product_url_3=none&s_productURL2=none&s_productURL2Name=none";
    }
    if (data.indexOf("product_url_4") == -1) {
      data = data + "&product_url_4=none&s_productURL4=none&s_productURL4Name=none";
    }
    if (data.indexOf("product_url_5") == -1) {
      data = data + "&product_url_5=none&s_productURL5=none&s_productURL5Name=none";
    }

    console.log("Data: " + data);
  } // getDonationInfo()

});
</script>

<script src="../assets/js/config.js" type="text/javascript"></script>
<script type="text/javascript" src="../assets/js/jquery.json-2.4.min.js"></script>
<script type="text/javascript" src="../assets/js/jstorage.js"></script>
<script src="../assets/js/jquery.uniform.js" type="text/javascript"></script>
<script src="../assets/js/date.js" type="text/javascript"></script>
<script src="../assets/js/form-validater.js" type="text/javascript"></script>
<script type="text/javascript"> var mawf = mawf || {}; mawf.validation_errors = {"js_name":{"errorEmpty":"Oops! Please enter a name.","errorInvalid":null},"js_site":{"errorEmpty":"Oops! Please enter a url.","errorInvalid":null},"js_mname":{"errorEmpty":"Oops! Please enter a wedding couple name.","errorInvalid":null},"js_fname":{"errorEmpty":"Oops! Please enter a first name.","errorInvalid":null},"js_fname_dependency":{"errorEmpty":"Oops! Please enter a first name.","errorInvalid":null},"js_lname":{"errorEmpty":"Oops! Please enter a last name.","errorInvalid":null},"js_fname-legacy":{"errorEmpty":"Oops! Please enter a first name.","errorInvalid":null},"js_address":{"errorEmpty":"Oops! Please enter an address.","errorInvalid":null},"js_city":{"errorEmpty":"Oops! Please enter a city.","errorInvalid":null},"js_state":{"errorEmpty":"Oops! Please select a state.","errorInvalid":"Oops! State is not appropriate for your country choice."},"js_stateonly":{"errorEmpty":"Oops! Please select a state.","errorInvalid":null},"js_zip":{"errorEmpty":"Oops! Please enter a postal code.","errorInvalid":"Oops! Please enter a valid postal code."},"js_ifMailCheckbox":{"errorEmpty":"Oops! This field is now required.","errorInvalid":null},"js_isZip":{"errorEmpty":null,"errorInvalid":"Oops! Please enter a valid postal code."},"js_ziponly":{"errorEmpty":"Oops! Please enter a postal code.","errorInvalid":"Oops! Please enter a valid postal code."},"js_legacyFor":{"errorEmpty":"Oops! Please select one.","errorInvalid":null},"js_country":{"errorEmpty":"Oops! Please select a country.","errorInvalid":"Oops! Please select a valid country."},"js_phone":{"errorEmpty":"Oops! Please enter a valid phone number.","errorInvalid":"Oops! Please enter a valid phone number."},"js_quesCom":{"errorEmpty":"Oops! Please enter a question or comment.","errorInvalid":null},"js_relationship":{"errorEmpty":"Oops! Please select your relationship. ","errorInvalid":null},"js_wishtitle":{"errorEmpty":"Oops! Please include a headline.","errorInvalid":null},"js_wishstory":{"errorEmpty":"Oops! Please include body text to explain how the story impacted yourself or others.","errorInvalid":null},"js_storyAgeCheck":{"errorEmpty":null,"errorInvalid":"Oops! If you are under 13 years of age, please ask your parent or guardian to share your story with us."},"js_org":{"errorEmpty":"Oops! Please enter the name of your company.","errorInvalid":null},"js_companydesc":{"errorEmpty":"Oops! Please select a company description.","errorInvalid":null},"js_size":{"errorEmpty":"Oops! Please select a company size.","errorInvalid":null},"js_companyGiving":{"errorEmpty":"Oops! Please indicate either yes or no.","errorInvalid":null},"js_msg1":{"errorEmpty":null,"errorInvalid":"Oops! This message is longer than 53 characters."},"js_text1":{"errorEmpty":null,"errorInvalid":"Oops! The personal message can only be 370 characters long. Please shorten your message."},"js_picture":{"errorEmpty":"Oops! Please submit a picture.","errorInvalid":"Oops! Please select an image file."},"js_email":{"errorEmpty":"Oops! Please enter a valid email address.","errorInvalid":"Oops! Please enter a valid email address."},"js_emailOptional":{"errorEmpty":"Oops! Please enter a valid email address.","errorInvalid":"Oops! Please enter a valid email address."},"js_emailCompare":{"errorEmpty":"Oops! Please enter an email address that matches the above email address.","errorInvalid":"Oops! Please enter an email address that matches the above email address."},"js_emailOptionalCompare":{"errorEmpty":"Oops! Please enter an email address that matches the above email address.","errorInvalid":"Oops! Please enter an email address that matches the above email address."},"js_donationAmount":{"errorEmpty":"Oops! Please enter a donation amount.","errorInvalid":null},"js_donationDest":{"errorEmpty":"Oops! Please enter a donation destination.","errorInvalid":"No matching results found!"},"js_donationDest-legacy":{"errorEmpty":"Oops! Please enter a donation destination.","errorInvalid":"No matching results found!"},"js_url":{"errorEmpty":"Oops! Please enter a URL.","errorInvalid":"Oops! Please enter a valid URL."},"js_selectreq":{"errorEmpty":"Oops! Please select one.","errorInvalid":null},"js_milesacct":{"errorEmpty":"Oops! Please enter your airline account digits.","errorInvalid":null},"js_ccFName":{"errorEmpty":"Oops! Card holder's name is required.","errorInvalid":null},"js_ccNumber":{"errorEmpty":"Oops! Please enter a valid credit card number.","errorInvalid":"Oops! Please enter a valid credit card number."},"js_ccSecNumber":{"errorEmpty":"Oops! Please enter a security number.","errorInvalid":"Oops! Please enter a valid security number."},"js_ccExpMonth":{"errorEmpty":"Oops! Please select a valid expiration month.","errorInvalid":"Oops! Please select a valid expiration month."},"js_ccExpYear":{"errorEmpty":"Oops! Please select a valid expiration year.","errorInvalid":"Oops! Please select a valid expiration year."},"js_milesdonate":{"errorEmpty":"Oops! Please enter a valid number of miles.","errorInvalid":"Oops! Please enter a valid number of miles."},"js_topQuestion":{"errorEmpty":"Oops! Please select an area of interest.","errorInvalid":null},"js_agecheck":{"errorEmpty":null,"errorInvalid":"Oops! You must be at least 13 years old to receive newsletters."},"js_optIn":{"errorEmpty":"Oops! Please select which newsletters you with to receive.","errorInvalid":null},"js_selectOneGeneric":{"errorEmpty":"Oops! Please select one.","errorInvalid":null},"js_selectBool":{"errorEmpty":"Oops! Please choose yes or no.","errorInvalid":null},"js_airmilesDonated":{"errorEmpty":"Oops! Please enter a valid number of miles.","errorInvalid":null},"js_airmilesAccount":{"errorEmpty":"Oops! Please enter your airline account digits.","errorInvalid":null},"js_categoryGeneric":{"errorEmpty":"Oops! Please choose one category.","errorInvalid":null},"js_organization":{"errorEmpty":"Oops! Please enter your organization name.","errorInvalid":null},"js_company":{"errorEmpty":"Oops! Please enter the name of your company.","errorInvalid":null},"js_position":{"errorEmpty":"Oops! Please enter your position.","errorInvalid":null},"js_headline":{"errorEmpty":"Oops! Please include a headline.","errorInvalid":null},"js_storyBody":{"errorEmpty":"Oops! Please include body text to explain how the story impacted yourself or others.","errorInvalid":null},"js_recognition":{"errorEmpty":"Oops! Please enter your name unless you wish to remain anonymous.","errorInvalid":null},"js_fname-pers":{"errorEmpty":"Oops! First name is required.","errorInvalid":null},"js_lname-pers":{"errorEmpty":"Oops! Last name is required.","errorInvalid":null},"js_fname-pers2":{"errorEmpty":"Oops! First name is required.","errorInvalid":null},"js_lname-pers2":{"errorEmpty":"Oops! Last name is required.","errorInvalid":null},"js_SITReq":{"errorEmpty":"Oops! Please select at least one.","errorInvalid":null},"js_airYear":{"errorEmpty":null,"errorInvalid":"Oops! Please select a valid date."},"js_airMonth":{"errorEmpty":null,"errorInvalid":"Oops! Please select a valid date."},"js_airDay":{"errorEmpty":null,"errorInvalid":"Oops! Please select a valid date."},"js_fname1":{"errorEmpty":"Oops! Please enter a first name.","errorInvalid":null},"js_lname1":{"errorEmpty":"Oops! Please enter a last name.","errorInvalid":null},"js_donationToCountry":{"errorEmpty":null,"errorInvalid":"No matching results found!"},"js_genericChapLoc":{"errorEmpty":"Oops! Please select a valid chapter.","errorInvalid":"No matching results found!"}}</script>
<script type="text/javascript"> var mawf = mawf || {}; mawf.transactional_errors = {"genericContactUs":"If you continue to receive this error message, please contact the bank that issued the card. You may also call us at 1-866-880-1382 to make your donation by phone.","decline":"Oops! Your credit card has been declined. Please enter a different credit card number and try again.","invalid_number":"Oops! You have entered an invalid credit card number.  Please enter a different credit card number and try again.","invalid_exp":"Oops! You have entered an invalid expiration date.  Please check the date, re-enter it and try again.","invalid_csc":"Oops! Your credit card security code is invalid.  Please re-enter it and try again.","amount_0":"Oops! We encountered a problem processing your donation.  Please start again.","clearTokenAndReset":"Oops! We encountered a problem processing your donation.  Please start again.","processing_incomplete":"Oops! We encountered a problem processing your donation.  Please try submitting it again.","timeout":"Oops! We encountered a problem processing your donation.  Please try submitting it again."}</script>
<script src="../assets/js/jquery.cookie.js" type="text/javascript"></script>
<script src="../assets/js/jquery-placeholder.js" type="text/javascript"></script>
<script src="../assets/js/jquery.fancybox.js" type="text/javascript"></script>
<script src="../assets/js/jquery.qtip.min.js" type="text/javascript"></script>
<script src="../assets/js/swfobject.js" type="text/javascript"></script>
<script src="../assets/js/waypoints.js" type="text/javascript"></script>
<script src="../assets/js/jquery.scrollTo.js" type="text/javascript"></script>
<script src="../assets/js/jquery.imagesloaded.min.js" type="text/javascript"></script>
<script src="../assets/js/jquery.mawsocial.js" type="text/javascript"></script>
<script src="../assets/js/global.js" type="text/javascript"></script>
<script src="../assets/js/wishes.js" type="text/javascript"></script>
<script src="../assets/js/home.js" type="text/javascript"></script>
<script src="../assets/js/custom-select-menu.jquery.js"></script>
<script src="../assets/js/leave-comment.js" type="text/javascript"></script>
<script defer src="https://www.youtube.com/player_api" type="text/javascript"></script>
<script src="../assets/js/addthis.js" type="text/javascript"></script>
<script src="../assets/js/rot.js" type="text/javascript"></script>

<!-- DONATION SPECIFIC JS -->
<script type='text/javascript' src='../assets/js/knockout-latest.js'></script>
<script src="../assets/js/ko-custom.concat.js?14" type="text/javascript"></script>
<script>
// Get chapter info from JSON file
chaptersjson = (function () {
  var json = null;
  $.ajax({
    'async': false,
    'global': false,
    'url': 'https://secure2.convio.net/wish/assets/js/chapters.json',
    'dataType': "json",
    'success': function (data) {
      json = data;
    }
  });
  return json;
})();

(function ($) {
  $('a.checkDonations').click(function (e) {
    var donations = mawf.CartView.donations()
    e.preventDefault();
    console.log(donations.length + ' donations.');
    for (var i in donations) {
      console.log(donations[i]);
      console.log(donations[i].donationID());
    }
    getDonationInfo();
  });

  function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
      vars[key] = value;
    });
    return vars;
  }

  var urlVariableArray = getUrlVars();

  for (var index in urlVariableArray) {
    if (index.substring(0, 2) == "s_") {
      data = data + "&" + index + "=" + urlVariableArray[index];
    }
  }

  var level1 = getUrlVars()["level1"];
  var level2 = getUrlVars()["level2"];
  var level3 = getUrlVars()["level3"];
  var level4 = getUrlVars()["level4"];
  var level5 = getUrlVars()["level5"];
  var level6 = getUrlVars()["level6"];
  var level7 = getUrlVars()["level7"];
  var cid = getUrlVars()["cid"] || "100-000";
  var chapter_prefix = cid.substring(0, 3);

  if (level1 < 1 || isNaN(level1)) {
    level1 = 30;
  } else {
    level1 = Math.floor(level1);
  }

  if (level2 < 1 || isNaN(level2)) {
    level2 = 50;
  } else {
    level2 = Math.floor(level2);
  }

  if (level3 < 1 || isNaN(level3)) {
    level3 = 100;
  } else {
    level3 = Math.floor(level3);
  }

  if (level4 < 1 || isNaN(level4)) {
    level4 = 150;
  } else {
    level4 = Math.floor(level4);
  }

  if (level5 < 1 || isNaN(level5)) {
    level5 = 250;
  } else {
    level5 = Math.floor(level5);
  }

  if (level6 < 1 || isNaN(level6)) {
    level6 = 500;
  } else {
    level6 = Math.floor(level6);
  }

  if (level7 < 1 || isNaN(level7)) {
    level7 = 1000;
  } else {
    level7 = Math.floor(level7);
  }

  numLevels = $('.ammount-btn').length;

  if (numLevels > 3) {
    $('.donate-wrap .other').css("float", "left");
    $('.donate-wrap .ammount-btn').css("margin-bottom", "10px");
  }

  if (cid && cid != "100-000") {

    var orgChapterName = "";
    var orgCenter = "";

    $(chaptersjson['allChapters']['chapter']).each(function (index, arr) {
      if (arr['office_id'] == cid) {
        orgChapterName = arr['office_name'];
        orgCenter = arr['center_id'];
        mawf.donation_init({
          localizedCurrencySymbol: '$',
          donorIntentId: cid,
          donorIntentName: orgChapterName,
          donationType1Label: 'A Single Donation',
          donationType2Label: 'A Monthly Pledge',
          minimumDonation: '5',
          donationAmt1: level1,
          donationAmt2: level2,
          donationAmt3: level3,
          donationAmt4: level4,
          donationAmt5: level5,
          donationAmt6: level6,
          donationAmt7: level7,
          startDate1: 5,
          startDate2: 20,
          clearFormMessage: 'Clearing the form will remove all your entered information. Are you sure you wish to proceed?',
          clearFormBtnYes: 'Yes, clear form',
          clearFormBtnNo: 'No, take me back to the form',
          nationalID: '100-000',
          nationalName: 'Make-A-Wish® America',
          internationalID: '500-000',
          internationalName: 'Make-A-Wish® International',
          purchaserID: cid,
          purchaserName: orgChapterName,
          sitChapterID: cid,
          sitChapter: orgChapterName,
          sitCenter: orgCenter
        });
        return false;
      }
    });

  } else {
    mawf.donation_init({
      localizedCurrencySymbol: '$',
      donorIntentId: '100-000',
      donorIntentName: 'Make-A-Wish® America',
      donationType1Label: 'A Single Donation',
      donationType2Label: 'A Monthly Pledge',
      minimumDonation: '5',
      donationAmt1: level1,
      donationAmt2: level2,
      donationAmt3: level3,
      donationAmt4: level4,
      donationAmt5: level5,
      donationAmt6: level6,
      donationAmt7: level7,
      startDate1: 5,
      startDate2: 20,
      clearFormMessage: 'Clearing the form will remove all your entered information. Are you sure you wish to proceed?',
      clearFormBtnYes: 'Yes, clear form',
      clearFormBtnNo: 'No, take me back to the form',
      nationalID: '100-000',
      nationalName: 'Make-A-Wish® America',
      internationalID: '500-000',
      internationalName: 'Make-A-Wish® International',
      purchaserID: '100-000',
      purchaserName: 'Make-A-Wish® America',
      sitChapterID: '100-000',
      sitChapter: 'Make-A-Wish® America',
      sitCenter: '1001'
    });
  }

  if (cid && cid != "100-000") {
    $('#localOptin').insertBefore('#nationalOptin');
    $('.intouch-container:eq(0)').addClass('selected');
    $('.intouch-container:eq(0) input').prop('checked', true);
    console.log('CID is set to: ' + cid);
    $("input[name='s_sat_chapter_id']").val(cid);
  } else {
    console.log('CID is not set');
    $("input[name='s_sat_chapter_id']").val("100-000");
  }

  data = 'method=donate&form_id=1420';

  $('.sendCards').click(function (e) {
    e.preventDefault();
    sendCards();
  });

  function getNextMonth() {
    var dayOfMonth = Date.today().toString('d');

    if (dayOfMonth == '29' || dayOfMonth == '30' || dayOfMonth == '31') {
      return Date.today().moveToFirstDayOfMonth().addMonths(2).toString('M/d/yyyy');
    } else {
      return Date.today().next().month().toString('M/d/yyyy');
    }
  }

  $('.nextMonth').each(function () {
    $(this).append(getNextMonth());
  });

  var thisChapter = '';

  $(document).on('keyup', '.js_donationDest', function (e) {
    var thisZip = $(this).val();

    if (thisZip.length < 5 || thisZip.length > 5) {
      $('ul.search-menu').html('');
    } else {
      $.getJSON('../assets/js/zip-codes.json', function (data) {
        $(data['chapter']).each(function (index, arr) {
          if (arr['zip_code'] == thisZip) {
            thisChapter = arr['chapter_id'];
            $(chaptersjson['allChapters']['chapter']).each(function (index, arr) {
              if (arr['office_id'] == thisChapter) {
                $('ul.search-menu').html('<li><a href="#" data-office-id="' + thisChapter + '" class="chapter-btn">' + arr['office_name'] + '</a></li>');
                return;
              }
            });
          }
        });

      });

    }
  });

  $(document).on('keyup', '.js_genericChapLoc', function (e) {
    var thisZip = $(this).val();

    if (thisZip.length < 5 || thisZip.length > 5) {
      $('ul.search-menu').html('');
    } else {
      $.getJSON('../assets/js/zip-codes.json', function (data) {
        $(data['chapter']).each(function (index, arr) {
          if (arr['zip_code'] == thisZip) {
            thisChapter = arr['chapter_id'];
            $(chaptersjson['allChapters']['chapter']).each(function (index, arr) {
              if (arr['office_id'] == thisChapter) {
                $('ul.search-menu').html('<li><a href="#" data-office-id="' + thisChapter + '" class="chapter-btn">' + arr['office_name'] + '</a></li>');
                return;
              }
            });
          }
        });

      });

    }
  });

  $('a.state-btn').click(function (e) {
    e.preventDefault();
    var state = $(this).text();
    var stateResults = [];
    var $chapterResults = $('.js-chapter-results ul');
    $chapterResults.html('');

    $(chaptersjson['allChapters']['chapter']).each(function (index, arr) {
      if (arr['state_province'] == state) {
        stateResults.push([arr['office_id'], arr['office_name']])
      }
    }); //each loop

    for (var i = 0; i < stateResults.length; i++) {
      var stateResult = stateResults[i]
      $chapterResults.append('<li><a class="chapter-btn" data-office-id="' + stateResult[0] + '" href="#" >' + stateResult[1] + '</a></li>');
    }
  });
})(jQuery);
</script>

<script type='text/javascript' src='../assets/js/bootstrap-typeahead.js'></script>
<script type="text/javascript" src="../assets/js/luminateExtend.js"></script>

<script>
luminateExtend.init({
  apiKey: 'mu3fefod',
  path: {
    nonsecure: 'http://site.wish.org/site/',
    secure: 'https://secure2.convio.net/wish/site/'
  }
});

var xmlHttp = new XMLHttpRequest();

function showError(pageError, fieldError) {
  alert(pageError + " " + fieldError);
  $("a.button-submit").css("cursor", "pointer").removeClass("disabled").removeAttr("disabled").bind('click', function (e) {
    e.preventDefault();
    $(this).unbind("click").css("cursor", "not-allowed").addClass("disabled").attr("disabled", true).click(function (e) {
      e.preventDefault();
    });

    getDonationInfo();

    luminateExtend.api.request({
      api: 'donation',
      form: '#mainform',
      data: data,
      requestType: 'POST',
      callback: function (data) {
        console.log(data);
        if (data['donationResponse']['donation']) {
          finishGift();
        }
        if (data['donationResponse']['errors']) {
          var fieldError = "";
          if (data['donationResponse']['errors']['fieldError']) {
            if ($.isArray(data['donationResponse']['errors']['fieldError'])) {
              $(data['donationResponse']['errors']['fieldError']).each(function (index, arr) {
                fieldError = fieldError + arr + " ";
              });
            } else {
              fieldError = data['donationResponse']['errors']['fieldError'];
            }
          }
          showError(data['donationResponse']['errors']['pageError'], fieldError);
        }
      }
    });

  });

}

var addCentersCallback = function (data) {
  console.log("Add Centers Callback: " + data);

};

var addCentersCallbackLast = function (data) {
  console.log("Add Centers Callback Last: " + data);
  lastStep();
};

function lastStep() {
  console.log("last step");
  $.removeCookie("cart");
  $.jStorage.flush();
  localStorage.clear();
  savedSession = {}
  $("#mainform input").each(function () {
    $(this).val("");
  });

  window.onbeforeunload = function () {};
  window.location = "https://secure2.convio.net/wish/site/SPageNavigator/donate_thankyou.html";
}

$('#ccPostal').blur(function(e){
  console.log("zip code blur 006");
  var id_from_billing_zip;  

  $(zip_array['chapter']).each(function (index, arr) {
    if (arr['zip_code'] == $('#ccPostal').val()) {
      id_from_billing_zip = arr['chapter_id'];
      
      $('#chapter_id').val(id_from_billing_zip);
    } 
  });  
  
});

function finishGift() {
  console.log("finish gift");
  var survey_ids = [];

  if ($('#optinNational').is(':checked')) {
    survey_ids.push("1604");
  }
  if ($('#optinInternational').hasClass('checked')) {
    survey_ids.push("1625");
  }
  if ($('#optinChapter').is(':checked')) {
    $(chaptersjson['allChapters']['chapter']).each(function (index, arr) {
      if (arr['office_id'] == $('#chapter_id').val()) {
        survey_ids.push(arr['surveyID']);
      }
    });
  }

  if (survey_ids.length > 0) {
    for (var i = 0; i < survey_ids.length; i++) {
      console.log(i + ", " + survey_ids.length);

      if ((navigator.userAgent.match(/MSIE 9/i))) {
        console.log("ie9");
        xmlHttp.abort();
      }

      if (i + 1 == survey_ids.length) {
        data = "method=submitSurvey&cons_email=" + encodeURIComponent($("#eAdd").val()) + "&cons_email_opt_in=true&survey_id=" + survey_ids[i];
        luminateExtend.api.request({
          api: 'survey',
          data: data,
          callback: addCentersCallbackLast,
          requiresAuth: true,
          requestType: 'POST',
          useHTTPS: true
        });
      } else {
        data = "method=submitSurvey&cons_email=" + encodeURIComponent($("#eAdd").val()) + "&cons_email_opt_in=true&survey_id=" + survey_ids[i];
        luminateExtend.api.request({
          api: 'survey',
          data: data,
          callback: addCentersCallback,
          requiresAuth: true,
          requestType: 'POST',
          useHTTPS: true
        });
      }
    }
  } else {
    lastStep();
  }
}

jQuery(document).ready(function ($) {
  $("a.action-btn, a.btn-modal").click(function (e) {
    e.preventDefault();
  });

  $("a.button-submit").click(function (e) {
    e.preventDefault();
    $(this).unbind("click").css("cursor", "not-allowed").addClass("disabled").attr("disabled", true).click(function (e) {
      e.preventDefault();
    });

    getDonationInfo();

    luminateExtend.api.request({
      api: 'donation',
      form: '#mainform',
      data: data,
      requestType: 'POST',
      callback: function (data) {
        console.log(data);
        if (data['donationResponse']['donation']) {
          finishGift();
        }
        if (data['donationResponse']['errors']) {
          var fieldError = "";
          if (data['donationResponse']['errors']['fieldError']) {
            if ($.isArray(data['donationResponse']['errors']['fieldError'])) {
              $(data['donationResponse']['errors']['fieldError']).each(function (index, arr) {
                fieldError = fieldError + arr + " ";
              });
            } else {
              fieldError = data['donationResponse']['errors']['fieldError'];
            }
          }
          showError(data['donationResponse']['errors']['pageError'], fieldError);
        }
      }
    });
  });
});
</script>